<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StagedToken 代币创建器 - BSC测试网</title>
    <!-- 主要的 ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <!-- 备用 CDN，如果主要的失败 -->
    <script>
        if (typeof ethers === 'undefined') {
            document.write('<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"><\/script>');
        }
    </script>

    <!-- 第二个备用 CDN -->
    <script>
        setTimeout(function() {
            if (typeof ethers === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js';
                script.onload = function() {
                    console.log('✅ Ethers.js 备用库加载成功');
                };
                script.onerror = function() {
                    console.error('❌ 所有 Ethers.js CDN 都加载失败');
                    showLibraryError();
                };
                document.head.appendChild(script);
            }
        }, 100);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 428px;
            margin: 0 auto;
            background: #000000;
            min-height: 100vh;
            position: relative;
        }

        /* 顶部导航栏 */
        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: #000000;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #1a1a1a;
        }

        .back-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
        }

        .nav-title {
            font-size: 17px;
            font-weight: 600;
            color: #ffffff;
        }

        .nav-spacer {
            width: 34px;
        }

        /* 主要内容 */
        .main-content {
            padding: 24px 20px;
        }

        /* 主标题 */
        .main-title {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            text-align: center;
            margin-bottom: 32px;
            line-height: 1.2;
        }

        .main-title .highlight {
            color: #4A90E2;
        }

        /* 模式切换 */
        .mode-switch {
            display: flex;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 32px;
            max-width: 200px;
            margin-left: auto;
            margin-right: auto;
        }

        .mode-btn {
            flex: 1;
            background: none;
            border: none;
            color: #888888;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #ffffff;
            color: #000000;
        }

        /* Logo上传区域 */
        .logo-upload {
            background: #1a1a1a;
            border: 2px dashed #333333;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 32px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .logo-upload:hover {
            border-color: #4A90E2;
        }

        .logo-upload-icon {
            font-size: 48px;
            color: #4A90E2;
            margin-bottom: 12px;
        }

        .logo-upload-text {
            color: #888888;
            font-size: 14px;
        }

        .logo-upload-subtext {
            color: #666666;
            font-size: 12px;
            margin-top: 4px;
        }

        /* 状态卡片 */
        .status-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #333333;
        }

        .status-icon {
            display: none;
        }

        .status-text h3 {
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        .status-text p {
            color: #888888;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .wallet-info {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #333333;
        }

        .wallet-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .wallet-info div:last-child {
            margin-bottom: 0;
        }

        .wallet-info span:first-child {
            color: #888888;
        }

        .wallet-info span:last-child {
            color: #ffffff;
            font-family: monospace;
        }

        .connect-btn {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 14px;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
        }

        .connect-btn:disabled {
            background: #333333;
            cursor: not-allowed;
            transform: none;
        }

        /* 表单样式 */
        .form-card {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            border: none;
        }

        .form-title {
            display: none;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffffff;
            font-size: 16px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 8px;
            font-size: 16px;
            color: #ffffff;
            transition: border-color 0.3s;
            font-family: inherit;
            resize: vertical;
        }

        .form-group input::placeholder {
            color: #666666;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .form-group small {
            color: #666666;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        /* 字符计数 */
        .char-count {
            color: #666666;
            font-size: 12px;
            text-align: right;
            margin-top: 4px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* 模板选择 */
        .templates {
            margin: 24px 0;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }

        .templates h4 {
            margin-bottom: 16px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .template-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .template-btn {
            background: #1a1a1a;
            border: 1px solid #333333;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #888888;
            transition: all 0.3s;
        }

        .template-btn:hover, .template-btn.active {
            border-color: #4A90E2;
            background: #4A90E2;
            color: white;
        }

        /* 费用信息隐藏 */
        .fee-info {
            display: none;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .fee-item.total {
            font-weight: bold;
            border-top: 1px solid #333333;
            padding-top: 8px;
            margin-top: 8px;
        }

        /* 创建按钮 */
        .create-btn {
            width: 100%;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 32px;
        }

        .create-btn:hover {
            transform: translateY(-1px);
        }

        .create-btn:disabled {
            background: #333333;
            cursor: not-allowed;
            transform: none;
        }

        /* 交易卡片 */
        .transaction-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
            border: 1px solid #333333;
        }

        .transaction-card h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .transaction-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .status-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666666;
        }

        .status-step.active .step-icon {
            background: #4A90E2;
            color: white;
        }

        .status-step.completed .step-icon {
            background: #28a745;
            color: white;
        }

        .step-text {
            font-size: 12px;
            color: #888888;
            text-align: center;
        }

        .status-step.active .step-text,
        .status-step.completed .step-text {
            color: #ffffff;
        }

        .transaction-details {
            background: #0a0a0a;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #333333;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            align-items: center;
            font-size: 14px;
        }

        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-item span:first-child {
            color: #888888;
        }

        .detail-item span:last-child {
            color: #ffffff;
        }

        .detail-item a {
            color: #4A90E2;
            text-decoration: none;
            font-family: monospace;
        }

        /* 页脚 */
        .footer {
            background: #000000;
            color: #666666;
            padding: 24px 20px;
            text-align: center;
            border-top: 1px solid #1a1a1a;
        }

        .footer a {
            color: #888888;
            text-decoration: none;
            margin: 0 8px;
            font-size: 12px;
        }

        .footer a:hover {
            color: #4A90E2;
        }

        .footer small {
            font-size: 10px;
            color: #666666;
        }

        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #333333;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #888888;
        }

        .modal-body {
            color: #ffffff;
        }

        .modal-body h4 {
            color: #ffffff;
            margin: 16px 0 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-body p {
            color: #888888;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .modal-body ul {
            margin-left: 16px;
            color: #888888;
            font-size: 14px;
        }

        .modal-body li {
            margin-bottom: 4px;
        }

        /* 响应式设计 */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }

            .main-content {
                padding: 20px 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .template-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .transaction-status {
                flex-direction: column;
                gap: 16px;
            }

            .mode-switch {
                max-width: 100%;
            }
        }

        /* 隐藏原有的header */
        .header {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="top-nav">
            <button class="back-btn">←</button>
            <div class="nav-title">RWAunion</div>
            <div class="nav-spacer"></div>
        </div>

        <!-- 头部 -->
        <div class="header">
            <h1>🪙 StagedToken 创建器</h1>
            <p>在BSC测试网上创建您的专属代币</p>
        </div>

        <!-- 主要内容 -->
        <div class="main-content">
            <!-- 主标题 -->
            <h1 class="main-title">Launch your token<br>on <span class="highlight">RWAunion</span></h1>

            <!-- 模式切换 -->
            <div class="mode-switch">
                <button class="mode-btn active">Simple</button>
                <button class="mode-btn">Advanced</button>
            </div>

            <!-- Logo上传区域 -->
            <div class="logo-upload" onclick="document.getElementById('logoInput').click()">
                <div class="logo-upload-icon">📷</div>
                <div class="logo-upload-text">JPEG/PNG/WEBP/GIF</div>
                <div class="logo-upload-subtext">Less Than 4MB</div>
                <input type="file" id="logoInput" accept="image/*" style="display: none;">
            </div>

            <!-- 连接状态 -->
            <div class="status-card" id="statusCard">
                <div class="status-icon" id="statusIcon">🔌</div>
                <div class="status-text">
                    <h3 id="statusTitle">请连接MetaMask钱包</h3>
                    <p id="statusDesc">连接到BSC测试网开始创建代币</p>
                    <button class="connect-btn" id="connectBtn">连接钱包</button>
                </div>
                <div class="wallet-info" id="walletInfo" style="display: none;">
                    <div>
                        <span>钱包地址:</span>
                        <span id="walletAddress">-</span>
                    </div>
                    <div>
                        <span>BNB余额:</span>
                        <span id="walletBalance">-</span>
                    </div>
                </div>
            </div>

            <!-- 代币创建表单 -->
            <div class="form-card" id="formCard" style="display: none;">
                <h2 class="form-title">创建新代币</h2>
                <form class="token-form" id="tokenForm">
                    <div class="form-group">
                        <label for="tokenName">* Token Name</label>
                        <input type="text" id="tokenName" placeholder="Token name" required maxlength="20">
                        <div class="char-count">0/20</div>
                    </div>

                    <div class="form-group">
                        <label for="tokenSymbol">* Token Symbol(Ticker)</label>
                        <input type="text" id="tokenSymbol" placeholder="Token Symbol" required maxlength="10">
                        <div class="char-count">0/10</div>
                    </div>

                    <div class="form-group">
                        <label for="totalSupply">* Supply</label>
                        <input type="number" id="totalSupply" placeholder="1000000000" required min="1">
                    </div>

                    <div class="form-group">
                        <label for="tokenomicPreset">* Choose Tokenomic preset</label>
                        <select id="tokenomicPreset" required>
                            <option value="">Meme Category</option>
                            <option value="meme">Meme Tax - 0.5% / 0.5%</option>
                            <option value="standard">Standard - 1% / 3%</option>
                            <option value="high">High Tax - 3% / 7%</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tokenDescription">* Token Description</label>
                        <textarea id="tokenDescription" placeholder="Token Description" maxlength="256" rows="4"></textarea>
                        <div class="char-count">0/256</div>
                    </div>

                    <div class="form-group">
                        <label for="website">Website</label>
                        <input type="text" id="website" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label for="telegram">Telegram</label>
                        <input type="text" id="telegram" placeholder="@username or username">
                    </div>

                    <div class="form-group">
                        <label for="twitter">Twitter</label>
                        <input type="text" id="twitter" placeholder="@username or username">
                    </div>

                    <!-- 备份资产 -->
                    <div class="form-group">
                        <label>Backing asset</label>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                            <span style="color: #ff4444; font-size: 20px;">🔴</span>
                            <span style="color: #ff4444; font-size: 14px;">TRX</span>
                            <span style="color: #888888; font-size: 14px;">✓</span>
                        </div>
                    </div>

                    <!-- 预设模板 -->
                    <div class="templates" style="display: none;">
                        <h4>快速模板</h4>
                        <div class="template-buttons">
                            <button type="button" class="template-btn" data-template="standard">
                                标准代币 (1% / 3%)
                            </button>
                            <button type="button" class="template-btn" data-template="low-fee">
                                低费用 (0.5% / 1%)
                            </button>
                            <button type="button" class="template-btn" data-template="high-fee">
                                高费用 (3% / 7%)
                            </button>
                        </div>
                    </div>

                    <!-- 费用信息 -->
                    <div class="fee-info">
                        <div class="fee-item">
                            <span>创建费用:</span>
                            <span id="creationFee">0.03 BNB</span>
                        </div>
                        <div class="fee-item">
                            <span>预估Gas费:</span>
                            <span id="estimatedGas">~0.01 BNB</span>
                        </div>
                        <div class="fee-item total">
                            <span>总费用:</span>
                            <span id="totalFee">~0.04 BNB</span>
                        </div>
                    </div>

                    <button type="submit" class="create-btn" id="createBtn">
                        <span class="btn-text">Create token</span>
                        <span class="btn-loader" style="display: none;">⏳ 创建中...</span>
                    </button>
                </form>
            </div>

            <!-- 交易状态 -->
            <div class="transaction-card" id="transactionCard" style="display: none;">
                <h3>交易状态</h3>
                <div class="transaction-status" id="transactionStatus">
                    <div class="status-step active" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-text">确认交易</div>
                    </div>
                    <div class="status-step" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-text">等待确认</div>
                    </div>
                    <div class="status-step" id="step3">
                        <div class="step-icon">3</div>
                        <div class="step-text">创建完成</div>
                    </div>
                </div>
                <div class="transaction-details" id="transactionDetails">
                    <div class="detail-item">
                        <span>交易哈希:</span>
                        <a href="#" target="_blank" id="txHash">-</a>
                    </div>
                    <div class="detail-item">
                        <span>代币地址:</span>
                        <a href="#" target="_blank" id="tokenAddress">-</a>
                    </div>
                    <div class="detail-item">
                        <span>Gas使用:</span>
                        <span id="gasUsed">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <div class="footer">
            <a href="https://testnet.bscscan.com" target="_blank">BSCScan测试网</a>
            <a href="https://testnet.binance.org/faucet-smart" target="_blank">获取测试BNB</a>
            <a href="#" onclick="showHelp()">使用帮助</a>
            <br><br>
            <small>工厂合约: <a href="https://testnet.bscscan.com/address/0x073faD54A73333EC1671522b9cCCbbBd153DA265" target="_blank">0x073f...A265</a> | BSC测试网 (Chain ID: 97)</small>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div class="modal" id="helpModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>使用帮助</h3>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <h4>1. 连接MetaMask</h4>
                <p>点击"连接钱包"按钮，选择MetaMask并授权连接。</p>

                <h4>2. 配置BSC测试网</h4>
                <p>确保MetaMask已添加BSC测试网络：</p>
                <ul>
                    <li>网络名称: BSC Testnet</li>
                    <li>RPC URL: https://data-seed-prebsc-1-s1.binance.org:8545/</li>
                    <li>Chain ID: 97</li>
                    <li>符号: BNB</li>
                </ul>

                <h4>3. 获取测试BNB</h4>
                <p>访问 <a href="https://testnet.binance.org/faucet-smart" target="_blank">BSC测试网水龙头</a> 获取免费的测试BNB。</p>

                <h4>4. 创建代币</h4>
                <p>填写代币信息，确认交易，等待区块链确认即可。</p>
            </div>
        </div>
    </div>

    <script>
        // 合约配置
        const CONTRACT_CONFIG = {
            FACTORY_ADDRESS: '0x073faD54A73333EC1671522b9cCCbbBd153DA265',
            BSC_TESTNET_CHAIN_ID: 97,
            BSC_TESTNET_RPC: 'https://data-seed-prebsc-1-s1.binance.org:8545/',
            BSCSCAN_BASE_URL: 'https://testnet.bscscan.com'
        };

        // 工厂合约ABI
        const FACTORY_ABI = [
            "function createToken(string memory name, string memory symbol, uint256 totalSupply, uint256 buyFee, uint256 sellFee) external payable returns (address)",
            "function creationFee() external view returns (uint256)",
            "event TokenCreated(address indexed creator, address indexed token, string name, string symbol)"
        ];

        // 全局变量
        let provider;
        let signer;
        let factory;
        let userAddress;

        // 显示库加载错误
        function showLibraryError() {
            updateStatus('❌', '库加载失败', 'Ethers.js 库加载失败，请刷新页面重试');
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = '库加载失败';

            // 显示调试信息
            console.error('🔍 调试信息:');
            console.error('- ethers 对象:', typeof ethers);
            console.error('- window.ethereum:', typeof window.ethereum);
            console.error('- 用户代理:', navigator.userAgent);
        }

        // 显示库加载成功信息
        function showLibrarySuccess() {
            console.log('🔍 库加载成功信息:');
            console.log('- ethers 版本:', ethers.version);
            console.log('- ethers 对象:', ethers);
            console.log('- window.ethereum:', typeof window.ethereum);
        }

        // 检查库是否加载
        function checkLibraryLoaded() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50; // 5秒超时

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (typeof ethers !== 'undefined') {
                        clearInterval(checkInterval);
                        console.log('✅ Ethers.js 库加载成功');
                        showLibrarySuccess();
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('❌ Ethers.js 库加载超时');
                        showLibraryError();
                        resolve(false);
                    }
                }, 100);
            });
        }

        // 初始化应用
        async function init() {
            // 防止重复初始化
            if (window.appInitialized) {
                console.log('📄 应用已经初始化，跳过');
                return;
            }

            console.log('📄 开始初始化应用...');

            // 首先检查库是否加载
            const libraryLoaded = await checkLibraryLoaded();
            if (!libraryLoaded) {
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                showError('请安装MetaMask钱包');
                return;
            }

            // 设置事件监听器
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('tokenForm').addEventListener('submit', createToken);

            // 模板按钮事件
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', applyTemplate);
            });

            // 检查是否已连接
            if (window.ethereum.selectedAddress) {
                await connectWallet();
            }

            // 标记初始化完成
            window.appInitialized = true;
            console.log('✅ 应用初始化完成');
        }

        // 连接钱包
        async function connectWallet() {
            try {
                // 再次检查 ethers 是否可用
                if (typeof ethers === 'undefined') {
                    throw new Error('Ethers.js 库未加载，请刷新页面重试');
                }

                updateStatus('🔄', '连接中...', '正在连接MetaMask钱包');

                // 检查 MetaMask 是否可用
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('请安装MetaMask钱包');
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // 检查网络
                const network = await provider.getNetwork();
                if (network.chainId !== CONTRACT_CONFIG.BSC_TESTNET_CHAIN_ID) {
                    await switchToBSCTestnet();
                    return;
                }

                // 获取余额
                const balance = await provider.getBalance(userAddress);
                const balanceInBNB = ethers.utils.formatEther(balance);

                // 初始化工厂合约
                factory = new ethers.Contract(CONTRACT_CONFIG.FACTORY_ADDRESS, FACTORY_ABI, signer);

                // 更新UI
                updateStatus('✅', '钱包已连接', `已连接到BSC测试网`);
                document.getElementById('walletAddress').textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
                document.getElementById('walletBalance').textContent = `${parseFloat(balanceInBNB).toFixed(4)} BNB`;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectBtn').textContent = '已连接';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('formCard').style.display = 'block';

                // 获取创建费用
                try {
                    const creationFee = await factory.creationFee();
                    document.getElementById('creationFee').textContent = `${ethers.utils.formatEther(creationFee)} BNB`;
                } catch (error) {
                    console.error('获取创建费用失败:', error);
                }

            } catch (error) {
                console.error('连接钱包失败:', error);
                showError(`连接失败: ${error.message}`);
            }
        }

        // 切换到BSC测试网
        async function switchToBSCTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x61' }], // 97 in hex
                });
                await connectWallet();
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x61',
                                chainName: 'BSC Testnet',
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                                blockExplorerUrls: ['https://testnet.bscscan.com/']
                            }]
                        });
                        await connectWallet();
                    } catch (addError) {
                        showError('添加BSC测试网失败');
                    }
                } else {
                    showError('切换网络失败');
                }
            }
        }

        // 应用模板
        function applyTemplate(event) {
            const template = event.target.dataset.template;
            const templateMapping = {
                'standard': 'standard',
                'low-fee': 'meme',  // 映射到meme预设 (0.5% / 0.5%)
                'high-fee': 'high'  // 映射到high预设 (3% / 7%)
            };

            if (templateMapping[template]) {
                const tokenomicPreset = document.getElementById('tokenomicPreset');
                if (tokenomicPreset) {
                    tokenomicPreset.value = templateMapping[template];
                }
            }
        }

        // 创建代币
        async function createToken(event) {
            event.preventDefault();

            try {
                const name = document.getElementById('tokenName').value;
                const symbol = document.getElementById('tokenSymbol').value;
                const totalSupply = document.getElementById('totalSupply').value;

                // 根据选择的预设获取费用
                const tokenomicPreset = document.getElementById('tokenomicPreset').value;
                let buyFee = 0;
                let sellFee = 0;

                // 根据预设设置费用
                const feePresets = {
                    'meme': { buyFee: 0.5, sellFee: 0.5 },
                    'standard': { buyFee: 1, sellFee: 3 },
                    'high': { buyFee: 3, sellFee: 7 }
                };

                if (tokenomicPreset && feePresets[tokenomicPreset]) {
                    buyFee = feePresets[tokenomicPreset].buyFee;
                    sellFee = feePresets[tokenomicPreset].sellFee;
                }

                if (!name || !symbol || !totalSupply) {
                    showError('请填写所有必填字段');
                    return;
                }

                // 显示交易状态
                document.getElementById('transactionCard').style.display = 'block';
                updateTransactionStep(1);

                // 禁用按钮
                const createBtn = document.getElementById('createBtn');
                createBtn.disabled = true;
                document.querySelector('.btn-text').style.display = 'none';
                document.querySelector('.btn-loader').style.display = 'inline';

                // 获取创建费用
                const creationFee = await factory.creationFee();

                // 创建代币
                // 智能费用转换 - 尝试多种格式直到找到合适的

                async function tryCreateTokenWithDifferentFeeFormats(name, symbol, totalSupply, buyFeePercent, sellFeePercent, creationFee) {
                    const conversionMethods = [
                        { name: '直接百分比整数', factor: 1, description: '1% = 1', minValue: 1 },
                        { name: '千分比', factor: 10, description: '1% = 10', minValue: 1 },
                        { name: '基点', factor: 100, description: '1% = 100', minValue: 1 }
                    ];

                    for (const method of conversionMethods) {
                        try {
                            let buyFeeConverted = Math.floor(parseFloat(buyFeePercent) * method.factor);
                            let sellFeeConverted = Math.floor(parseFloat(sellFeePercent) * method.factor);

                            // 确保最小值，避免零费用
                            if (buyFeeConverted === 0 && parseFloat(buyFeePercent) > 0) buyFeeConverted = method.minValue;
                            if (sellFeeConverted === 0 && parseFloat(sellFeePercent) > 0) sellFeeConverted = method.minValue;

                            console.log(`� 尝试 ${method.name}: ${buyFeePercent}% → ${buyFeeConverted}, ${sellFeePercent}% → ${sellFeeConverted}`);

                            // 尝试估算gas来检查是否会被拒绝
                            await factory.estimateGas.createToken(
                                name,
                                symbol,
                                totalSupply,
                                buyFeeConverted,
                                sellFeeConverted,
                                { value: creationFee }
                            );

                            console.log(`✅ ${method.name} 格式通过验证！`);

                            // 如果gas估算成功，执行实际交易
                            return await factory.createToken(
                                name,
                                symbol,
                                totalSupply,
                                buyFeeConverted,
                                sellFeeConverted,
                                { value: creationFee }
                            );

                        } catch (error) {
                            console.log(`❌ ${method.name} 失败: ${error.message}`);
                            continue;
                        }
                    }

                    throw new Error('所有费用转换格式都失败了');
                }

                console.log(`💰 开始智能费用转换测试...`);

                const tx = await tryCreateTokenWithDifferentFeeFormats(
                    name,
                    symbol,
                    totalSupply,
                    buyFee,
                    sellFee,
                    creationFee
                );

                // 更新交易哈希
                document.getElementById('txHash').textContent = `${tx.hash.slice(0,10)}...${tx.hash.slice(-8)}`;
                document.getElementById('txHash').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}`;

                updateTransactionStep(2);

                // 等待确认
                const receipt = await tx.wait();
                console.log('交易回执:', receipt);

                // 多种方法解析TokenCreated事件
                let tokenAddress = null;
                let parseMethod = '';

                // 方法1: 使用receipt.events (ethers v5风格)
                if (receipt.events && receipt.events.length > 0) {
                    console.log('尝试方法1: receipt.events');
                    const tokenCreatedEvent = receipt.events.find(
                        event => event.event === 'TokenCreated'
                    );
                    if (tokenCreatedEvent && tokenCreatedEvent.args) {
                        tokenAddress = tokenCreatedEvent.args.token;
                        parseMethod = 'receipt.events';
                        console.log('方法1成功，代币地址:', tokenAddress);
                    }
                }

                // 方法2: 使用合约接口解析日志
                if (!tokenAddress && receipt.logs && receipt.logs.length > 0) {
                    console.log('尝试方法2: 合约接口解析日志');
                    try {
                        const iface = new ethers.utils.Interface(FACTORY_ABI);
                        for (const log of receipt.logs) {
                            try {
                                const parsedLog = iface.parseLog(log);
                                console.log('解析的日志:', parsedLog);
                                if (parsedLog.name === 'TokenCreated') {
                                    tokenAddress = parsedLog.args.token;
                                    parseMethod = '合约接口解析';
                                    console.log('方法2成功，代币地址:', tokenAddress);
                                    break;
                                }
                            } catch (logError) {
                                // 忽略无法解析的日志
                                console.log('跳过无法解析的日志:', logError.message);
                            }
                        }
                    } catch (error) {
                        console.error('接口解析失败:', error);
                    }
                }

                // 方法3: 手动解析日志数据
                if (!tokenAddress && receipt.logs && receipt.logs.length > 0) {
                    console.log('尝试方法3: 手动解析日志');
                    try {
                        // TokenCreated事件的签名哈希
                        const tokenCreatedTopic = ethers.utils.id('TokenCreated(address,address,string,string)');
                        console.log('TokenCreated事件签名:', tokenCreatedTopic);

                        for (const log of receipt.logs) {
                            console.log('检查日志:', log);
                            if (log.topics && log.topics[0] === tokenCreatedTopic) {
                                // 第二个topic是token地址 (indexed参数)
                                if (log.topics.length >= 3) {
                                    tokenAddress = ethers.utils.getAddress('0x' + log.topics[2].slice(26));
                                    parseMethod = '手动解析日志';
                                    console.log('方法3成功，代币地址:', tokenAddress);
                                    break;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('手动解析失败:', error);
                    }
                }

                // 显示解析结果
                if (tokenAddress) {
                    console.log(`✅ 成功获取代币地址: ${tokenAddress} (使用${parseMethod})`);

                    // 更新UI
                    document.getElementById('tokenAddress').textContent = `${tokenAddress.slice(0,10)}...${tokenAddress.slice(-8)}`;
                    document.getElementById('tokenAddress').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}`;
                    document.getElementById('gasUsed').textContent = receipt.gasUsed.toString();

                    updateTransactionStep(3);

                    // 显示详细的成功信息
                    showSuccess(`
                        <div style="text-align: left;">
                            <div><strong>🎉 代币创建成功！</strong></div>
                            <div style="margin-top: 8px;">
                                <strong>代币信息:</strong><br>
                                名称: ${name}<br>
                                符号: ${symbol}<br>
                                总供应量: ${totalSupply}<br>
                                买入手续费: ${buyFee}%<br>
                                卖出手续费: ${sellFee}%
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>合约地址:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tokenAddress}
                                </a>
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>交易哈希:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tx.hash}
                                </a>
                            </div>
                        </div>
                    `);

                    // 保存到历史记录
                    saveToHistory({
                        name, symbol, totalSupply, buyFee, sellFee,
                        tokenAddress, txHash: tx.hash,
                        timestamp: new Date().toISOString()
                    });

                } else {
                    console.error('❌ 所有方法都无法获取代币地址');
                    console.log('交易回执详情:', JSON.stringify(receipt, null, 2));

                    // 提供更详细的错误信息和解决方案
                    showError(`
                        <div style="text-align: left;">
                            <div><strong>⚠️ 代币创建成功，但无法自动获取地址</strong></div>
                            <div style="margin-top: 8px;">
                                交易已成功执行，但前端无法解析事件日志。<br>
                                请通过以下方式查看代币信息：
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>1. 查看交易详情:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tx.hash}
                                </a>
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>2. 在BSCScan中:</strong><br>
                                • 点击上方交易链接<br>
                                • 查看 "To" 字段中的合约地址<br>
                                • 或在 "Logs" 标签页中找到TokenCreated事件
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>Gas使用量:</strong> ${receipt.gasUsed.toString()}
                            </div>
                        </div>
                    `);

                    // 仍然更新交易步骤，显示部分信息
                    document.getElementById('gasUsed').textContent = receipt.gasUsed.toString();
                    updateTransactionStep(3);
                }

            } catch (error) {
                console.error('创建代币失败:', error);
                showError(`创建失败: ${error.message}`);
            } finally {
                // 恢复按钮
                const createBtn = document.getElementById('createBtn');
                createBtn.disabled = false;
                document.querySelector('.btn-text').style.display = 'inline';
                document.querySelector('.btn-loader').style.display = 'none';
            }
        }

        // 更新状态
        function updateStatus(icon, title, desc) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusTitle').textContent = title;

            // 支持HTML内容
            const descElement = document.getElementById('statusDesc');
            if (desc.includes('<')) {
                descElement.innerHTML = desc;
            } else {
                descElement.textContent = desc;
            }
        }

        // 更新交易步骤
        function updateTransactionStep(step) {
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (i < step) {
                    stepElement.className = 'status-step completed';
                } else if (i === step) {
                    stepElement.className = 'status-step active';
                } else {
                    stepElement.className = 'status-step';
                }
            }
        }

        // 显示错误
        function showError(message) {
            updateStatus('❌', '错误', message);
        }

        // 显示成功
        function showSuccess(message) {
            updateStatus('🎉', '成功', message);
        }

        // 保存到历史记录
        function saveToHistory(tokenData) {
            const history = JSON.parse(localStorage.getItem('tokenHistory') || '[]');
            history.unshift(tokenData);
            localStorage.setItem('tokenHistory', JSON.stringify(history.slice(0, 10))); // 只保留最近10个
        }

        // 显示帮助
        function showHelp() {
            document.getElementById('helpModal').style.display = 'flex';
        }

        // 关闭帮助
        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // 初始化字符计数功能
        function initCharacterCount() {
            // Token Name 字符计数
            const tokenNameInput = document.getElementById('tokenName');
            const tokenNameCount = tokenNameInput.parentElement.querySelector('.char-count');
            tokenNameInput.addEventListener('input', function() {
                const count = this.value.length;
                tokenNameCount.textContent = `${count}/20`;
            });

            // Token Symbol 字符计数
            const tokenSymbolInput = document.getElementById('tokenSymbol');
            const tokenSymbolCount = tokenSymbolInput.parentElement.querySelector('.char-count');
            tokenSymbolInput.addEventListener('input', function() {
                const count = this.value.length;
                tokenSymbolCount.textContent = `${count}/10`;
            });

            // Token Description 字符计数
            const tokenDescInput = document.getElementById('tokenDescription');
            const tokenDescCount = tokenDescInput.parentElement.querySelector('.char-count');
            tokenDescInput.addEventListener('input', function() {
                const count = this.value.length;
                tokenDescCount.textContent = `${count}/256`;
            });

            // Twitter 用户名格式处理
            const twitterInput = document.getElementById('twitter');
            if (twitterInput) {
                twitterInput.addEventListener('input', function() {
                    let value = this.value.trim();
                    // 移除多余的@符号和空格
                    value = value.replace(/^@+/, '').replace(/\s+/g, '');
                    // 只允许字母、数字和下划线
                    value = value.replace(/[^a-zA-Z0-9_]/g, '');
                    // 限制长度（Twitter用户名最长15个字符）
                    if (value.length > 15) {
                        value = value.substring(0, 15);
                    }
                    this.value = value;
                });

                // 失去焦点时自动添加@前缀（如果用户输入了内容）
                twitterInput.addEventListener('blur', function() {
                    if (this.value.trim() && !this.value.startsWith('@')) {
                        this.value = '@' + this.value.trim();
                    }
                });

                // 获得焦点时移除@前缀以便编辑
                twitterInput.addEventListener('focus', function() {
                    if (this.value.startsWith('@')) {
                        this.value = this.value.substring(1);
                    }
                });
            }

            // Telegram 用户名格式处理
            const telegramInput = document.getElementById('telegram');
            if (telegramInput) {
                telegramInput.addEventListener('input', function() {
                    let value = this.value.trim();
                    // 移除多余的@符号和空格
                    value = value.replace(/^@+/, '').replace(/\s+/g, '');
                    // 只允许字母、数字和下划线
                    value = value.replace(/[^a-zA-Z0-9_]/g, '');
                    // 限制长度（Telegram用户名最长32个字符）
                    if (value.length > 32) {
                        value = value.substring(0, 32);
                    }
                    this.value = value;
                });

                // 失去焦点时自动添加@前缀（如果用户输入了内容）
                telegramInput.addEventListener('blur', function() {
                    if (this.value.trim() && !this.value.startsWith('@')) {
                        this.value = '@' + this.value.trim();
                    }
                });

                // 获得焦点时移除@前缀以便编辑
                telegramInput.addEventListener('focus', function() {
                    if (this.value.startsWith('@')) {
                        this.value = this.value.substring(1);
                    }
                });
            }

            // 模式切换功能
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // 页面加载时初始化
        window.addEventListener('load', function() {
            console.log('📄 页面加载完成，开始初始化...');
            init();
            initCharacterCount();
        });

        // DOM 内容加载完成时也尝试初始化（备用）
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM 内容加载完成');
            // 延迟一点时间确保脚本加载
            setTimeout(function() {
                if (typeof ethers !== 'undefined' && !window.appInitialized) {
                    console.log('📄 通过 DOMContentLoaded 初始化应用');
                    window.appInitialized = true;
                    init();
                }
            }, 500);
        });

        // 监听账户变化
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }
    </script>
</body>
</html>
