<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StagedToken ä»£å¸åˆ›å»ºå™¨ - BSCæµ‹è¯•ç½‘</title>
    <!-- ä¸»è¦çš„ ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <!-- å¤‡ç”¨ CDNï¼Œå¦‚æœä¸»è¦çš„å¤±è´¥ -->
    <script>
        if (typeof ethers === 'undefined') {
            document.write('<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"><\/script>');
        }
    </script>

    <!-- ç¬¬äºŒä¸ªå¤‡ç”¨ CDN -->
    <script>
        setTimeout(function() {
            if (typeof ethers === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js';
                script.onload = function() {
                    console.log('âœ… Ethers.js å¤‡ç”¨åº“åŠ è½½æˆåŠŸ');
                };
                script.onerror = function() {
                    console.error('âŒ æ‰€æœ‰ Ethers.js CDN éƒ½åŠ è½½å¤±è´¥');
                    showLibraryError();
                };
                document.head.appendChild(script);
            }
        }, 100);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 428px;
            margin: 0 auto;
            background: #000000;
            min-height: 100vh;
            position: relative;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: #000000;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #1a1a1a;
        }

        .back-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
        }

        .nav-title {
            font-size: 17px;
            font-weight: 600;
            color: #ffffff;
        }

        .nav-spacer {
            width: 34px;
        }

        /* ä¸»è¦å†…å®¹ */
        .main-content {
            padding: 24px 20px;
        }

        /* ä¸»æ ‡é¢˜ */
        .main-title {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            text-align: center;
            margin-bottom: 32px;
            line-height: 1.2;
        }

        .main-title .highlight {
            color: #4A90E2;
        }

        /* æ¨¡å¼åˆ‡æ¢ */
        .mode-switch {
            display: flex;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 32px;
            max-width: 200px;
            margin-left: auto;
            margin-right: auto;
        }

        .mode-btn {
            flex: 1;
            background: none;
            border: none;
            color: #888888;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #ffffff;
            color: #000000;
        }

        /* Logoä¸Šä¼ åŒºåŸŸ */
        .logo-upload {
            background: #1a1a1a;
            border: 2px dashed #333333;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 32px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .logo-upload:hover {
            border-color: #4A90E2;
        }

        .logo-upload-icon {
            font-size: 48px;
            color: #4A90E2;
            margin-bottom: 12px;
        }

        .logo-upload-text {
            color: #888888;
            font-size: 14px;
        }

        .logo-upload-subtext {
            color: #666666;
            font-size: 12px;
            margin-top: 4px;
        }

        /* çŠ¶æ€å¡ç‰‡ */
        .status-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid #333333;
        }

        .status-icon {
            display: none;
        }

        .status-text h3 {
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        .status-text p {
            color: #888888;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .wallet-info {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #333333;
        }

        .wallet-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .wallet-info div:last-child {
            margin-bottom: 0;
        }

        .wallet-info span:first-child {
            color: #888888;
        }

        .wallet-info span:last-child {
            color: #ffffff;
            font-family: monospace;
        }

        .connect-btn {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 14px;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
        }

        .connect-btn:disabled {
            background: #333333;
            cursor: not-allowed;
            transform: none;
        }

        /* è¡¨å•æ ·å¼ */
        .form-card {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            border: none;
        }

        .form-title {
            display: none;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffffff;
            font-size: 16px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 8px;
            font-size: 16px;
            color: #ffffff;
            transition: border-color 0.3s;
            font-family: inherit;
            resize: vertical;
        }

        .form-group input::placeholder {
            color: #666666;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .form-group small {
            color: #666666;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        /* å­—ç¬¦è®¡æ•° */
        .char-count {
            color: #666666;
            font-size: 12px;
            text-align: right;
            margin-top: 4px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* æ¨¡æ¿é€‰æ‹© */
        .templates {
            margin: 24px 0;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }

        .templates h4 {
            margin-bottom: 16px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .template-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .template-btn {
            background: #1a1a1a;
            border: 1px solid #333333;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #888888;
            transition: all 0.3s;
        }

        .template-btn:hover, .template-btn.active {
            border-color: #4A90E2;
            background: #4A90E2;
            color: white;
        }

        /* è´¹ç”¨ä¿¡æ¯éšè— */
        .fee-info {
            display: none;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .fee-item.total {
            font-weight: bold;
            border-top: 1px solid #333333;
            padding-top: 8px;
            margin-top: 8px;
        }

        /* åˆ›å»ºæŒ‰é’® */
        .create-btn {
            width: 100%;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 32px;
        }

        .create-btn:hover {
            transform: translateY(-1px);
        }

        .create-btn:disabled {
            background: #333333;
            cursor: not-allowed;
            transform: none;
        }

        /* äº¤æ˜“å¡ç‰‡ */
        .transaction-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
            border: 1px solid #333333;
        }

        .transaction-card h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .transaction-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .status-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666666;
        }

        .status-step.active .step-icon {
            background: #4A90E2;
            color: white;
        }

        .status-step.completed .step-icon {
            background: #28a745;
            color: white;
        }

        .step-text {
            font-size: 12px;
            color: #888888;
            text-align: center;
        }

        .status-step.active .step-text,
        .status-step.completed .step-text {
            color: #ffffff;
        }

        .transaction-details {
            background: #0a0a0a;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #333333;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            align-items: center;
            font-size: 14px;
        }

        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-item span:first-child {
            color: #888888;
        }

        .detail-item span:last-child {
            color: #ffffff;
        }

        .detail-item a {
            color: #4A90E2;
            text-decoration: none;
            font-family: monospace;
        }

        /* é¡µè„š */
        .footer {
            background: #000000;
            color: #666666;
            padding: 24px 20px;
            text-align: center;
            border-top: 1px solid #1a1a1a;
        }

        .footer a {
            color: #888888;
            text-decoration: none;
            margin: 0 8px;
            font-size: 12px;
        }

        .footer a:hover {
            color: #4A90E2;
        }

        .footer small {
            font-size: 10px;
            color: #666666;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #333333;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #888888;
        }

        .modal-body {
            color: #ffffff;
        }

        .modal-body h4 {
            color: #ffffff;
            margin: 16px 0 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-body p {
            color: #888888;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .modal-body ul {
            margin-left: 16px;
            color: #888888;
            font-size: 14px;
        }

        .modal-body li {
            margin-bottom: 4px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }

            .main-content {
                padding: 20px 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .template-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .transaction-status {
                flex-direction: column;
                gap: 16px;
            }

            .mode-switch {
                max-width: 100%;
            }
        }

        /* éšè—åŸæœ‰çš„header */
        .header {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="top-nav">
            <button class="back-btn">â†</button>
            <div class="nav-title">RWAunion</div>
            <div class="nav-spacer"></div>
        </div>

        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸª™ StagedToken åˆ›å»ºå™¨</h1>
            <p>åœ¨BSCæµ‹è¯•ç½‘ä¸Šåˆ›å»ºæ‚¨çš„ä¸“å±ä»£å¸</p>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- ä¸»æ ‡é¢˜ -->
            <h1 class="main-title">Launch your token<br>on <span class="highlight">RWAunion</span></h1>

            <!-- æ¨¡å¼åˆ‡æ¢ -->
            <div class="mode-switch">
                <button class="mode-btn active">Simple</button>
                <button class="mode-btn">Advanced</button>
            </div>

            <!-- Logoä¸Šä¼ åŒºåŸŸ -->
            <div class="logo-upload" onclick="document.getElementById('logoInput').click()">
                <div class="logo-upload-icon">ğŸ“·</div>
                <div class="logo-upload-text">JPEG/PNG/WEBP/GIF</div>
                <div class="logo-upload-subtext">Less Than 4MB</div>
                <input type="file" id="logoInput" accept="image/*" style="display: none;">
            </div>

            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="status-card" id="statusCard">
                <div class="status-icon" id="statusIcon">ğŸ”Œ</div>
                <div class="status-text">
                    <h3 id="statusTitle">è¯·è¿æ¥MetaMaské’±åŒ…</h3>
                    <p id="statusDesc">è¿æ¥åˆ°BSCæµ‹è¯•ç½‘å¼€å§‹åˆ›å»ºä»£å¸</p>
                    <button class="connect-btn" id="connectBtn">è¿æ¥é’±åŒ…</button>
                </div>
                <div class="wallet-info" id="walletInfo" style="display: none;">
                    <div>
                        <span>é’±åŒ…åœ°å€:</span>
                        <span id="walletAddress">-</span>
                    </div>
                    <div>
                        <span>BNBä½™é¢:</span>
                        <span id="walletBalance">-</span>
                    </div>
                </div>
            </div>

            <!-- ä»£å¸åˆ›å»ºè¡¨å• -->
            <div class="form-card" id="formCard" style="display: none;">
                <h2 class="form-title">åˆ›å»ºæ–°ä»£å¸</h2>
                <form class="token-form" id="tokenForm">
                    <div class="form-group">
                        <label for="tokenName">* Token Name</label>
                        <input type="text" id="tokenName" placeholder="Token name" required maxlength="20">
                        <div class="char-count">0/20</div>
                    </div>

                    <div class="form-group">
                        <label for="tokenSymbol">* Token Symbol(Ticker)</label>
                        <input type="text" id="tokenSymbol" placeholder="Token Symbol" required maxlength="10">
                        <div class="char-count">0/10</div>
                    </div>

                    <div class="form-group">
                        <label for="totalSupply">* Supply</label>
                        <input type="number" id="totalSupply" placeholder="1000000000" required min="1">
                    </div>

                    <div class="form-group">
                        <label for="tokenomicPreset">* Choose Tokenomic preset</label>
                        <select id="tokenomicPreset" required>
                            <option value="">Meme Category</option>
                            <option value="meme">Meme Tax - 0.5% / 0.5%</option>
                            <option value="standard">Standard - 1% / 3%</option>
                            <option value="high">High Tax - 3% / 7%</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tokenDescription">* Token Description</label>
                        <textarea id="tokenDescription" placeholder="Token Description" maxlength="256" rows="4"></textarea>
                        <div class="char-count">0/256</div>
                    </div>

                    <div class="form-group">
                        <label for="website">Website</label>
                        <input type="text" id="website" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label for="telegram">Telegram</label>
                        <input type="text" id="telegram" placeholder="@username or username">
                    </div>

                    <div class="form-group">
                        <label for="twitter">Twitter</label>
                        <input type="text" id="twitter" placeholder="@username or username">
                    </div>

                    <!-- å¤‡ä»½èµ„äº§ -->
                    <div class="form-group">
                        <label>Backing asset</label>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                            <span style="color: #ff4444; font-size: 20px;">ğŸ”´</span>
                            <span style="color: #ff4444; font-size: 14px;">TRX</span>
                            <span style="color: #888888; font-size: 14px;">âœ“</span>
                        </div>
                    </div>

                    <!-- é¢„è®¾æ¨¡æ¿ -->
                    <div class="templates" style="display: none;">
                        <h4>å¿«é€Ÿæ¨¡æ¿</h4>
                        <div class="template-buttons">
                            <button type="button" class="template-btn" data-template="standard">
                                æ ‡å‡†ä»£å¸ (1% / 3%)
                            </button>
                            <button type="button" class="template-btn" data-template="low-fee">
                                ä½è´¹ç”¨ (0.5% / 1%)
                            </button>
                            <button type="button" class="template-btn" data-template="high-fee">
                                é«˜è´¹ç”¨ (3% / 7%)
                            </button>
                        </div>
                    </div>

                    <!-- è´¹ç”¨ä¿¡æ¯ -->
                    <div class="fee-info">
                        <div class="fee-item">
                            <span>åˆ›å»ºè´¹ç”¨:</span>
                            <span id="creationFee">0.03 BNB</span>
                        </div>
                        <div class="fee-item">
                            <span>é¢„ä¼°Gasè´¹:</span>
                            <span id="estimatedGas">~0.01 BNB</span>
                        </div>
                        <div class="fee-item total">
                            <span>æ€»è´¹ç”¨:</span>
                            <span id="totalFee">~0.04 BNB</span>
                        </div>
                    </div>

                    <button type="submit" class="create-btn" id="createBtn">
                        <span class="btn-text">Create token</span>
                        <span class="btn-loader" style="display: none;">â³ åˆ›å»ºä¸­...</span>
                    </button>
                </form>
            </div>

            <!-- äº¤æ˜“çŠ¶æ€ -->
            <div class="transaction-card" id="transactionCard" style="display: none;">
                <h3>äº¤æ˜“çŠ¶æ€</h3>
                <div class="transaction-status" id="transactionStatus">
                    <div class="status-step active" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-text">ç¡®è®¤äº¤æ˜“</div>
                    </div>
                    <div class="status-step" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-text">ç­‰å¾…ç¡®è®¤</div>
                    </div>
                    <div class="status-step" id="step3">
                        <div class="step-icon">3</div>
                        <div class="step-text">åˆ›å»ºå®Œæˆ</div>
                    </div>
                </div>
                <div class="transaction-details" id="transactionDetails">
                    <div class="detail-item">
                        <span>äº¤æ˜“å“ˆå¸Œ:</span>
                        <a href="#" target="_blank" id="txHash">-</a>
                    </div>
                    <div class="detail-item">
                        <span>ä»£å¸åœ°å€:</span>
                        <a href="#" target="_blank" id="tokenAddress">-</a>
                    </div>
                    <div class="detail-item">
                        <span>Gasä½¿ç”¨:</span>
                        <span id="gasUsed">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="footer">
            <a href="https://testnet.bscscan.com" target="_blank">BSCScanæµ‹è¯•ç½‘</a>
            <a href="https://testnet.binance.org/faucet-smart" target="_blank">è·å–æµ‹è¯•BNB</a>
            <a href="#" onclick="showHelp()">ä½¿ç”¨å¸®åŠ©</a>
            <br><br>
            <small>å·¥å‚åˆçº¦: <a href="https://testnet.bscscan.com/address/0x073faD54A73333EC1671522b9cCCbbBd153DA265" target="_blank">0x073f...A265</a> | BSCæµ‹è¯•ç½‘ (Chain ID: 97)</small>
        </div>
    </div>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div class="modal" id="helpModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä½¿ç”¨å¸®åŠ©</h3>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <h4>1. è¿æ¥MetaMask</h4>
                <p>ç‚¹å‡»"è¿æ¥é’±åŒ…"æŒ‰é’®ï¼Œé€‰æ‹©MetaMaskå¹¶æˆæƒè¿æ¥ã€‚</p>

                <h4>2. é…ç½®BSCæµ‹è¯•ç½‘</h4>
                <p>ç¡®ä¿MetaMaskå·²æ·»åŠ BSCæµ‹è¯•ç½‘ç»œï¼š</p>
                <ul>
                    <li>ç½‘ç»œåç§°: BSC Testnet</li>
                    <li>RPC URL: https://data-seed-prebsc-1-s1.binance.org:8545/</li>
                    <li>Chain ID: 97</li>
                    <li>ç¬¦å·: BNB</li>
                </ul>

                <h4>3. è·å–æµ‹è¯•BNB</h4>
                <p>è®¿é—® <a href="https://testnet.binance.org/faucet-smart" target="_blank">BSCæµ‹è¯•ç½‘æ°´é¾™å¤´</a> è·å–å…è´¹çš„æµ‹è¯•BNBã€‚</p>

                <h4>4. åˆ›å»ºä»£å¸</h4>
                <p>å¡«å†™ä»£å¸ä¿¡æ¯ï¼Œç¡®è®¤äº¤æ˜“ï¼Œç­‰å¾…åŒºå—é“¾ç¡®è®¤å³å¯ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_CONFIG = {
            FACTORY_ADDRESS: '0x073faD54A73333EC1671522b9cCCbbBd153DA265',
            BSC_TESTNET_CHAIN_ID: 97,
            BSC_TESTNET_RPC: 'https://data-seed-prebsc-1-s1.binance.org:8545/',
            BSCSCAN_BASE_URL: 'https://testnet.bscscan.com'
        };

        // å·¥å‚åˆçº¦ABI
        const FACTORY_ABI = [
            "function createToken(string memory name, string memory symbol, uint256 totalSupply, uint256 buyFee, uint256 sellFee) external payable returns (address)",
            "function creationFee() external view returns (uint256)",
            "event TokenCreated(address indexed creator, address indexed token, string name, string symbol)"
        ];

        // å…¨å±€å˜é‡
        let provider;
        let signer;
        let factory;
        let userAddress;

        // æ˜¾ç¤ºåº“åŠ è½½é”™è¯¯
        function showLibraryError() {
            updateStatus('âŒ', 'åº“åŠ è½½å¤±è´¥', 'Ethers.js åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = 'åº“åŠ è½½å¤±è´¥';

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            console.error('ğŸ” è°ƒè¯•ä¿¡æ¯:');
            console.error('- ethers å¯¹è±¡:', typeof ethers);
            console.error('- window.ethereum:', typeof window.ethereum);
            console.error('- ç”¨æˆ·ä»£ç†:', navigator.userAgent);
        }

        // æ˜¾ç¤ºåº“åŠ è½½æˆåŠŸä¿¡æ¯
        function showLibrarySuccess() {
            console.log('ğŸ” åº“åŠ è½½æˆåŠŸä¿¡æ¯:');
            console.log('- ethers ç‰ˆæœ¬:', ethers.version);
            console.log('- ethers å¯¹è±¡:', ethers);
            console.log('- window.ethereum:', typeof window.ethereum);
        }

        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
        function checkLibraryLoaded() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’è¶…æ—¶

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (typeof ethers !== 'undefined') {
                        clearInterval(checkInterval);
                        console.log('âœ… Ethers.js åº“åŠ è½½æˆåŠŸ');
                        showLibrarySuccess();
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('âŒ Ethers.js åº“åŠ è½½è¶…æ—¶');
                        showLibraryError();
                        resolve(false);
                    }
                }, 100);
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function init() {
            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (window.appInitialized) {
                console.log('ğŸ“„ åº”ç”¨å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡');
                return;
            }

            console.log('ğŸ“„ å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');

            // é¦–å…ˆæ£€æŸ¥åº“æ˜¯å¦åŠ è½½
            const libraryLoaded = await checkLibraryLoaded();
            if (!libraryLoaded) {
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                showError('è¯·å®‰è£…MetaMaské’±åŒ…');
                return;
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('tokenForm').addEventListener('submit', createToken);

            // æ¨¡æ¿æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', applyTemplate);
            });

            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
            if (window.ethereum.selectedAddress) {
                await connectWallet();
            }

            // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
            window.appInitialized = true;
            console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                // å†æ¬¡æ£€æŸ¥ ethers æ˜¯å¦å¯ç”¨
                if (typeof ethers === 'undefined') {
                    throw new Error('Ethers.js åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }

                updateStatus('ğŸ”„', 'è¿æ¥ä¸­...', 'æ­£åœ¨è¿æ¥MetaMaské’±åŒ…');

                // æ£€æŸ¥ MetaMask æ˜¯å¦å¯ç”¨
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== CONTRACT_CONFIG.BSC_TESTNET_CHAIN_ID) {
                    await switchToBSCTestnet();
                    return;
                }

                // è·å–ä½™é¢
                const balance = await provider.getBalance(userAddress);
                const balanceInBNB = ethers.utils.formatEther(balance);

                // åˆå§‹åŒ–å·¥å‚åˆçº¦
                factory = new ethers.Contract(CONTRACT_CONFIG.FACTORY_ADDRESS, FACTORY_ABI, signer);

                // æ›´æ–°UI
                updateStatus('âœ…', 'é’±åŒ…å·²è¿æ¥', `å·²è¿æ¥åˆ°BSCæµ‹è¯•ç½‘`);
                document.getElementById('walletAddress').textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
                document.getElementById('walletBalance').textContent = `${parseFloat(balanceInBNB).toFixed(4)} BNB`;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('formCard').style.display = 'block';

                // è·å–åˆ›å»ºè´¹ç”¨
                try {
                    const creationFee = await factory.creationFee();
                    document.getElementById('creationFee').textContent = `${ethers.utils.formatEther(creationFee)} BNB`;
                } catch (error) {
                    console.error('è·å–åˆ›å»ºè´¹ç”¨å¤±è´¥:', error);
                }

            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showError(`è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // åˆ‡æ¢åˆ°BSCæµ‹è¯•ç½‘
        async function switchToBSCTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x61' }], // 97 in hex
                });
                await connectWallet();
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x61',
                                chainName: 'BSC Testnet',
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                                blockExplorerUrls: ['https://testnet.bscscan.com/']
                            }]
                        });
                        await connectWallet();
                    } catch (addError) {
                        showError('æ·»åŠ BSCæµ‹è¯•ç½‘å¤±è´¥');
                    }
                } else {
                    showError('åˆ‡æ¢ç½‘ç»œå¤±è´¥');
                }
            }
        }

        // åº”ç”¨æ¨¡æ¿
        function applyTemplate(event) {
            const template = event.target.dataset.template;
            const templateMapping = {
                'standard': 'standard',
                'low-fee': 'meme',  // æ˜ å°„åˆ°memeé¢„è®¾ (0.5% / 0.5%)
                'high-fee': 'high'  // æ˜ å°„åˆ°highé¢„è®¾ (3% / 7%)
            };

            if (templateMapping[template]) {
                const tokenomicPreset = document.getElementById('tokenomicPreset');
                if (tokenomicPreset) {
                    tokenomicPreset.value = templateMapping[template];
                }
            }
        }

        // åˆ›å»ºä»£å¸
        async function createToken(event) {
            event.preventDefault();

            try {
                const name = document.getElementById('tokenName').value;
                const symbol = document.getElementById('tokenSymbol').value;
                const totalSupply = document.getElementById('totalSupply').value;

                // æ ¹æ®é€‰æ‹©çš„é¢„è®¾è·å–è´¹ç”¨
                const tokenomicPreset = document.getElementById('tokenomicPreset').value;
                let buyFee = 0;
                let sellFee = 0;

                // æ ¹æ®é¢„è®¾è®¾ç½®è´¹ç”¨
                const feePresets = {
                    'meme': { buyFee: 0.5, sellFee: 0.5 },
                    'standard': { buyFee: 1, sellFee: 3 },
                    'high': { buyFee: 3, sellFee: 7 }
                };

                if (tokenomicPreset && feePresets[tokenomicPreset]) {
                    buyFee = feePresets[tokenomicPreset].buyFee;
                    sellFee = feePresets[tokenomicPreset].sellFee;
                }

                if (!name || !symbol || !totalSupply) {
                    showError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                    return;
                }

                // æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€
                document.getElementById('transactionCard').style.display = 'block';
                updateTransactionStep(1);

                // ç¦ç”¨æŒ‰é’®
                const createBtn = document.getElementById('createBtn');
                createBtn.disabled = true;
                document.querySelector('.btn-text').style.display = 'none';
                document.querySelector('.btn-loader').style.display = 'inline';

                // è·å–åˆ›å»ºè´¹ç”¨
                const creationFee = await factory.creationFee();

                // åˆ›å»ºä»£å¸
                // æ™ºèƒ½è´¹ç”¨è½¬æ¢ - å°è¯•å¤šç§æ ¼å¼ç›´åˆ°æ‰¾åˆ°åˆé€‚çš„

                async function tryCreateTokenWithDifferentFeeFormats(name, symbol, totalSupply, buyFeePercent, sellFeePercent, creationFee) {
                    const conversionMethods = [
                        { name: 'ç›´æ¥ç™¾åˆ†æ¯”æ•´æ•°', factor: 1, description: '1% = 1', minValue: 1 },
                        { name: 'åƒåˆ†æ¯”', factor: 10, description: '1% = 10', minValue: 1 },
                        { name: 'åŸºç‚¹', factor: 100, description: '1% = 100', minValue: 1 }
                    ];

                    for (const method of conversionMethods) {
                        try {
                            let buyFeeConverted = Math.floor(parseFloat(buyFeePercent) * method.factor);
                            let sellFeeConverted = Math.floor(parseFloat(sellFeePercent) * method.factor);

                            // ç¡®ä¿æœ€å°å€¼ï¼Œé¿å…é›¶è´¹ç”¨
                            if (buyFeeConverted === 0 && parseFloat(buyFeePercent) > 0) buyFeeConverted = method.minValue;
                            if (sellFeeConverted === 0 && parseFloat(sellFeePercent) > 0) sellFeeConverted = method.minValue;

                            console.log(`ï¿½ å°è¯• ${method.name}: ${buyFeePercent}% â†’ ${buyFeeConverted}, ${sellFeePercent}% â†’ ${sellFeeConverted}`);

                            // å°è¯•ä¼°ç®—gasæ¥æ£€æŸ¥æ˜¯å¦ä¼šè¢«æ‹’ç»
                            await factory.estimateGas.createToken(
                                name,
                                symbol,
                                totalSupply,
                                buyFeeConverted,
                                sellFeeConverted,
                                { value: creationFee }
                            );

                            console.log(`âœ… ${method.name} æ ¼å¼é€šè¿‡éªŒè¯ï¼`);

                            // å¦‚æœgasä¼°ç®—æˆåŠŸï¼Œæ‰§è¡Œå®é™…äº¤æ˜“
                            return await factory.createToken(
                                name,
                                symbol,
                                totalSupply,
                                buyFeeConverted,
                                sellFeeConverted,
                                { value: creationFee }
                            );

                        } catch (error) {
                            console.log(`âŒ ${method.name} å¤±è´¥: ${error.message}`);
                            continue;
                        }
                    }

                    throw new Error('æ‰€æœ‰è´¹ç”¨è½¬æ¢æ ¼å¼éƒ½å¤±è´¥äº†');
                }

                console.log(`ğŸ’° å¼€å§‹æ™ºèƒ½è´¹ç”¨è½¬æ¢æµ‹è¯•...`);

                const tx = await tryCreateTokenWithDifferentFeeFormats(
                    name,
                    symbol,
                    totalSupply,
                    buyFee,
                    sellFee,
                    creationFee
                );

                // æ›´æ–°äº¤æ˜“å“ˆå¸Œ
                document.getElementById('txHash').textContent = `${tx.hash.slice(0,10)}...${tx.hash.slice(-8)}`;
                document.getElementById('txHash').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}`;

                updateTransactionStep(2);

                // ç­‰å¾…ç¡®è®¤
                const receipt = await tx.wait();
                console.log('äº¤æ˜“å›æ‰§:', receipt);

                // å¤šç§æ–¹æ³•è§£æTokenCreatedäº‹ä»¶
                let tokenAddress = null;
                let parseMethod = '';

                // æ–¹æ³•1: ä½¿ç”¨receipt.events (ethers v5é£æ ¼)
                if (receipt.events && receipt.events.length > 0) {
                    console.log('å°è¯•æ–¹æ³•1: receipt.events');
                    const tokenCreatedEvent = receipt.events.find(
                        event => event.event === 'TokenCreated'
                    );
                    if (tokenCreatedEvent && tokenCreatedEvent.args) {
                        tokenAddress = tokenCreatedEvent.args.token;
                        parseMethod = 'receipt.events';
                        console.log('æ–¹æ³•1æˆåŠŸï¼Œä»£å¸åœ°å€:', tokenAddress);
                    }
                }

                // æ–¹æ³•2: ä½¿ç”¨åˆçº¦æ¥å£è§£ææ—¥å¿—
                if (!tokenAddress && receipt.logs && receipt.logs.length > 0) {
                    console.log('å°è¯•æ–¹æ³•2: åˆçº¦æ¥å£è§£ææ—¥å¿—');
                    try {
                        const iface = new ethers.utils.Interface(FACTORY_ABI);
                        for (const log of receipt.logs) {
                            try {
                                const parsedLog = iface.parseLog(log);
                                console.log('è§£æçš„æ—¥å¿—:', parsedLog);
                                if (parsedLog.name === 'TokenCreated') {
                                    tokenAddress = parsedLog.args.token;
                                    parseMethod = 'åˆçº¦æ¥å£è§£æ';
                                    console.log('æ–¹æ³•2æˆåŠŸï¼Œä»£å¸åœ°å€:', tokenAddress);
                                    break;
                                }
                            } catch (logError) {
                                // å¿½ç•¥æ— æ³•è§£æçš„æ—¥å¿—
                                console.log('è·³è¿‡æ— æ³•è§£æçš„æ—¥å¿—:', logError.message);
                            }
                        }
                    } catch (error) {
                        console.error('æ¥å£è§£æå¤±è´¥:', error);
                    }
                }

                // æ–¹æ³•3: æ‰‹åŠ¨è§£ææ—¥å¿—æ•°æ®
                if (!tokenAddress && receipt.logs && receipt.logs.length > 0) {
                    console.log('å°è¯•æ–¹æ³•3: æ‰‹åŠ¨è§£ææ—¥å¿—');
                    try {
                        // TokenCreatedäº‹ä»¶çš„ç­¾åå“ˆå¸Œ
                        const tokenCreatedTopic = ethers.utils.id('TokenCreated(address,address,string,string)');
                        console.log('TokenCreatedäº‹ä»¶ç­¾å:', tokenCreatedTopic);

                        for (const log of receipt.logs) {
                            console.log('æ£€æŸ¥æ—¥å¿—:', log);
                            if (log.topics && log.topics[0] === tokenCreatedTopic) {
                                // ç¬¬äºŒä¸ªtopicæ˜¯tokenåœ°å€ (indexedå‚æ•°)
                                if (log.topics.length >= 3) {
                                    tokenAddress = ethers.utils.getAddress('0x' + log.topics[2].slice(26));
                                    parseMethod = 'æ‰‹åŠ¨è§£ææ—¥å¿—';
                                    console.log('æ–¹æ³•3æˆåŠŸï¼Œä»£å¸åœ°å€:', tokenAddress);
                                    break;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('æ‰‹åŠ¨è§£æå¤±è´¥:', error);
                    }
                }

                // æ˜¾ç¤ºè§£æç»“æœ
                if (tokenAddress) {
                    console.log(`âœ… æˆåŠŸè·å–ä»£å¸åœ°å€: ${tokenAddress} (ä½¿ç”¨${parseMethod})`);

                    // æ›´æ–°UI
                    document.getElementById('tokenAddress').textContent = `${tokenAddress.slice(0,10)}...${tokenAddress.slice(-8)}`;
                    document.getElementById('tokenAddress').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}`;
                    document.getElementById('gasUsed').textContent = receipt.gasUsed.toString();

                    updateTransactionStep(3);

                    // æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯
                    showSuccess(`
                        <div style="text-align: left;">
                            <div><strong>ğŸ‰ ä»£å¸åˆ›å»ºæˆåŠŸï¼</strong></div>
                            <div style="margin-top: 8px;">
                                <strong>ä»£å¸ä¿¡æ¯:</strong><br>
                                åç§°: ${name}<br>
                                ç¬¦å·: ${symbol}<br>
                                æ€»ä¾›åº”é‡: ${totalSupply}<br>
                                ä¹°å…¥æ‰‹ç»­è´¹: ${buyFee}%<br>
                                å–å‡ºæ‰‹ç»­è´¹: ${sellFee}%
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>åˆçº¦åœ°å€:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tokenAddress}
                                </a>
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>äº¤æ˜“å“ˆå¸Œ:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tx.hash}
                                </a>
                            </div>
                        </div>
                    `);

                    // ä¿å­˜åˆ°å†å²è®°å½•
                    saveToHistory({
                        name, symbol, totalSupply, buyFee, sellFee,
                        tokenAddress, txHash: tx.hash,
                        timestamp: new Date().toISOString()
                    });

                } else {
                    console.error('âŒ æ‰€æœ‰æ–¹æ³•éƒ½æ— æ³•è·å–ä»£å¸åœ°å€');
                    console.log('äº¤æ˜“å›æ‰§è¯¦æƒ…:', JSON.stringify(receipt, null, 2));

                    // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
                    showError(`
                        <div style="text-align: left;">
                            <div><strong>âš ï¸ ä»£å¸åˆ›å»ºæˆåŠŸï¼Œä½†æ— æ³•è‡ªåŠ¨è·å–åœ°å€</strong></div>
                            <div style="margin-top: 8px;">
                                äº¤æ˜“å·²æˆåŠŸæ‰§è¡Œï¼Œä½†å‰ç«¯æ— æ³•è§£æäº‹ä»¶æ—¥å¿—ã€‚<br>
                                è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ä»£å¸ä¿¡æ¯ï¼š
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>1. æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tx.hash}
                                </a>
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>2. åœ¨BSCScanä¸­:</strong><br>
                                â€¢ ç‚¹å‡»ä¸Šæ–¹äº¤æ˜“é“¾æ¥<br>
                                â€¢ æŸ¥çœ‹ "To" å­—æ®µä¸­çš„åˆçº¦åœ°å€<br>
                                â€¢ æˆ–åœ¨ "Logs" æ ‡ç­¾é¡µä¸­æ‰¾åˆ°TokenCreatedäº‹ä»¶
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>Gasä½¿ç”¨é‡:</strong> ${receipt.gasUsed.toString()}
                            </div>
                        </div>
                    `);

                    // ä»ç„¶æ›´æ–°äº¤æ˜“æ­¥éª¤ï¼Œæ˜¾ç¤ºéƒ¨åˆ†ä¿¡æ¯
                    document.getElementById('gasUsed').textContent = receipt.gasUsed.toString();
                    updateTransactionStep(3);
                }

            } catch (error) {
                console.error('åˆ›å»ºä»£å¸å¤±è´¥:', error);
                showError(`åˆ›å»ºå¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®
                const createBtn = document.getElementById('createBtn');
                createBtn.disabled = false;
                document.querySelector('.btn-text').style.display = 'inline';
                document.querySelector('.btn-loader').style.display = 'none';
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(icon, title, desc) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusTitle').textContent = title;

            // æ”¯æŒHTMLå†…å®¹
            const descElement = document.getElementById('statusDesc');
            if (desc.includes('<')) {
                descElement.innerHTML = desc;
            } else {
                descElement.textContent = desc;
            }
        }

        // æ›´æ–°äº¤æ˜“æ­¥éª¤
        function updateTransactionStep(step) {
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (i < step) {
                    stepElement.className = 'status-step completed';
                } else if (i === step) {
                    stepElement.className = 'status-step active';
                } else {
                    stepElement.className = 'status-step';
                }
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            updateStatus('âŒ', 'é”™è¯¯', message);
        }

        // æ˜¾ç¤ºæˆåŠŸ
        function showSuccess(message) {
            updateStatus('ğŸ‰', 'æˆåŠŸ', message);
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(tokenData) {
            const history = JSON.parse(localStorage.getItem('tokenHistory') || '[]');
            history.unshift(tokenData);
            localStorage.setItem('tokenHistory', JSON.stringify(history.slice(0, 10))); // åªä¿ç•™æœ€è¿‘10ä¸ª
        }

        // æ˜¾ç¤ºå¸®åŠ©
        function showHelp() {
            document.getElementById('helpModal').style.display = 'flex';
        }

        // å…³é—­å¸®åŠ©
        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°åŠŸèƒ½
        function initCharacterCount() {
            // Token Name å­—ç¬¦è®¡æ•°
            const tokenNameInput = document.getElementById('tokenName');
            const tokenNameCount = tokenNameInput.parentElement.querySelector('.char-count');
            tokenNameInput.addEventListener('input', function() {
                const count = this.value.length;
                tokenNameCount.textContent = `${count}/20`;
            });

            // Token Symbol å­—ç¬¦è®¡æ•°
            const tokenSymbolInput = document.getElementById('tokenSymbol');
            const tokenSymbolCount = tokenSymbolInput.parentElement.querySelector('.char-count');
            tokenSymbolInput.addEventListener('input', function() {
                const count = this.value.length;
                tokenSymbolCount.textContent = `${count}/10`;
            });

            // Token Description å­—ç¬¦è®¡æ•°
            const tokenDescInput = document.getElementById('tokenDescription');
            const tokenDescCount = tokenDescInput.parentElement.querySelector('.char-count');
            tokenDescInput.addEventListener('input', function() {
                const count = this.value.length;
                tokenDescCount.textContent = `${count}/256`;
            });

            // Twitter ç”¨æˆ·åæ ¼å¼å¤„ç†
            const twitterInput = document.getElementById('twitter');
            if (twitterInput) {
                twitterInput.addEventListener('input', function() {
                    let value = this.value.trim();
                    // ç§»é™¤å¤šä½™çš„@ç¬¦å·å’Œç©ºæ ¼
                    value = value.replace(/^@+/, '').replace(/\s+/g, '');
                    // åªå…è®¸å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
                    value = value.replace(/[^a-zA-Z0-9_]/g, '');
                    // é™åˆ¶é•¿åº¦ï¼ˆTwitterç”¨æˆ·åæœ€é•¿15ä¸ªå­—ç¬¦ï¼‰
                    if (value.length > 15) {
                        value = value.substring(0, 15);
                    }
                    this.value = value;
                });

                // å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨æ·»åŠ @å‰ç¼€ï¼ˆå¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹ï¼‰
                twitterInput.addEventListener('blur', function() {
                    if (this.value.trim() && !this.value.startsWith('@')) {
                        this.value = '@' + this.value.trim();
                    }
                });

                // è·å¾—ç„¦ç‚¹æ—¶ç§»é™¤@å‰ç¼€ä»¥ä¾¿ç¼–è¾‘
                twitterInput.addEventListener('focus', function() {
                    if (this.value.startsWith('@')) {
                        this.value = this.value.substring(1);
                    }
                });
            }

            // Telegram ç”¨æˆ·åæ ¼å¼å¤„ç†
            const telegramInput = document.getElementById('telegram');
            if (telegramInput) {
                telegramInput.addEventListener('input', function() {
                    let value = this.value.trim();
                    // ç§»é™¤å¤šä½™çš„@ç¬¦å·å’Œç©ºæ ¼
                    value = value.replace(/^@+/, '').replace(/\s+/g, '');
                    // åªå…è®¸å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
                    value = value.replace(/[^a-zA-Z0-9_]/g, '');
                    // é™åˆ¶é•¿åº¦ï¼ˆTelegramç”¨æˆ·åæœ€é•¿32ä¸ªå­—ç¬¦ï¼‰
                    if (value.length > 32) {
                        value = value.substring(0, 32);
                    }
                    this.value = value;
                });

                // å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨æ·»åŠ @å‰ç¼€ï¼ˆå¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹ï¼‰
                telegramInput.addEventListener('blur', function() {
                    if (this.value.trim() && !this.value.startsWith('@')) {
                        this.value = '@' + this.value.trim();
                    }
                });

                // è·å¾—ç„¦ç‚¹æ—¶ç§»é™¤@å‰ç¼€ä»¥ä¾¿ç¼–è¾‘
                telegramInput.addEventListener('focus', function() {
                    if (this.value.startsWith('@')) {
                        this.value = this.value.substring(1);
                    }
                });
            }

            // æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            init();
            initCharacterCount();
        });

        // DOM å†…å®¹åŠ è½½å®Œæˆæ—¶ä¹Ÿå°è¯•åˆå§‹åŒ–ï¼ˆå¤‡ç”¨ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOM å†…å®¹åŠ è½½å®Œæˆ');
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿è„šæœ¬åŠ è½½
            setTimeout(function() {
                if (typeof ethers !== 'undefined' && !window.appInitialized) {
                    console.log('ğŸ“„ é€šè¿‡ DOMContentLoaded åˆå§‹åŒ–åº”ç”¨');
                    window.appInitialized = true;
                    init();
                }
            }, 500);
        });

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }
    </script>
</body>
</html>
