<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StagedToken ä»£å¸åˆ›å»ºå™¨ - BSCæµ‹è¯•ç½‘</title>
    <!-- ä¸»è¦çš„ ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <!-- å¤‡ç”¨ CDNï¼Œå¦‚æœä¸»è¦çš„å¤±è´¥ -->
    <script>
        if (typeof ethers === 'undefined') {
            document.write('<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"><\/script>');
        }
    </script>

    <!-- ç¬¬äºŒä¸ªå¤‡ç”¨ CDN -->
    <script>
        setTimeout(function() {
            if (typeof ethers === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js';
                script.onload = function() {
                    console.log('âœ… Ethers.js å¤‡ç”¨åº“åŠ è½½æˆåŠŸ');
                };
                script.onerror = function() {
                    console.error('âŒ æ‰€æœ‰ Ethers.js CDN éƒ½åŠ è½½å¤±è´¥');
                    showLibraryError();
                };
                document.head.appendChild(script);
            }
        }, 100);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #28a745;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-icon {
            font-size: 3em;
        }

        .status-text h3 {
            color: #495057;
            margin-bottom: 5px;
        }

        .status-text p {
            color: #6c757d;
        }

        .wallet-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .wallet-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: monospace;
        }

        .connect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .form-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .form-title {
            color: #495057;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .templates {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .templates h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .template-btn {
            background: white;
            border: 2px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .template-btn:hover {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .fee-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .fee-item.total {
            font-weight: bold;
            border-top: 1px solid #bbdefb;
            padding-top: 8px;
            margin-top: 8px;
        }

        .create-btn {
            width: 100%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .create-btn:hover {
            transform: translateY(-2px);
        }

        .create-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .transaction-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .transaction-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .status-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-step.active .step-icon {
            background: #28a745;
            color: white;
        }

        .status-step.completed .step-icon {
            background: #007bff;
            color: white;
        }

        .transaction-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }

        .detail-item a {
            color: #007bff;
            text-decoration: none;
            font-family: monospace;
        }

        .footer {
            background: #343a40;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .footer a {
            color: #adb5bd;
            text-decoration: none;
            margin: 0 10px;
        }

        .footer a:hover {
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-body h4 {
            color: #495057;
            margin: 20px 0 10px 0;
        }

        .modal-body ul {
            margin-left: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .template-buttons {
                flex-direction: column;
            }
            
            .transaction-status {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸª™ StagedToken åˆ›å»ºå™¨</h1>
            <p>åœ¨BSCæµ‹è¯•ç½‘ä¸Šåˆ›å»ºæ‚¨çš„ä¸“å±ä»£å¸</p>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="status-card" id="statusCard">
                <div class="status-icon" id="statusIcon">ğŸ”Œ</div>
                <div class="status-text">
                    <h3 id="statusTitle">è¯·è¿æ¥MetaMaské’±åŒ…</h3>
                    <p id="statusDesc">è¿æ¥åˆ°BSCæµ‹è¯•ç½‘å¼€å§‹åˆ›å»ºä»£å¸</p>
                    <button class="connect-btn" id="connectBtn">è¿æ¥é’±åŒ…</button>
                </div>
                <div class="wallet-info" id="walletInfo" style="display: none;">
                    <div>
                        <span>é’±åŒ…åœ°å€:</span>
                        <span id="walletAddress">-</span>
                    </div>
                    <div>
                        <span>BNBä½™é¢:</span>
                        <span id="walletBalance">-</span>
                    </div>
                </div>
            </div>

            <!-- ä»£å¸åˆ›å»ºè¡¨å• -->
            <div class="form-card" id="formCard" style="display: none;">
                <h2 class="form-title">åˆ›å»ºæ–°ä»£å¸</h2>
                <form class="token-form" id="tokenForm">
                    <div class="form-group">
                        <label for="tokenName">ä»£å¸åç§°</label>
                        <input type="text" id="tokenName" placeholder="ä¾‹å¦‚: My Awesome Token" required>
                        <small>ä»£å¸çš„å®Œæ•´åç§°</small>
                    </div>

                    <div class="form-group">
                        <label for="tokenSymbol">ä»£å¸ç¬¦å·</label>
                        <input type="text" id="tokenSymbol" placeholder="ä¾‹å¦‚: MAT" required maxlength="10">
                        <small>ä»£å¸çš„ç®€ç§°ï¼Œé€šå¸¸3-5ä¸ªå­—ç¬¦</small>
                    </div>

                    <div class="form-group">
                        <label for="totalSupply">æ€»ä¾›åº”é‡</label>
                        <input type="number" id="totalSupply" placeholder="1000000" required min="1">
                        <small>ä»£å¸çš„æ€»å‘è¡Œé‡</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="buyFee">ä¹°å…¥è´¹ç”¨ (%)</label>
                            <input type="number" id="buyFee" placeholder="2" min="0" max="10" step="0.1">
                            <small>ä¹°å…¥æ—¶æ”¶å–çš„è´¹ç”¨ (0-10%)</small>
                        </div>

                        <div class="form-group">
                            <label for="sellFee">å–å‡ºè´¹ç”¨ (%)</label>
                            <input type="number" id="sellFee" placeholder="5" min="0" max="10" step="0.1">
                            <small>å–å‡ºæ—¶æ”¶å–çš„è´¹ç”¨ (0-10%)</small>
                        </div>
                    </div>

                    <!-- é¢„è®¾æ¨¡æ¿ -->
                    <div class="templates">
                        <h4>å¿«é€Ÿæ¨¡æ¿</h4>
                        <div class="template-buttons">
                            <button type="button" class="template-btn" data-template="standard">
                                æ ‡å‡†ä»£å¸ (1% / 3%)
                            </button>
                            <button type="button" class="template-btn" data-template="low-fee">
                                ä½è´¹ç”¨ (0.5% / 1%)
                            </button>
                            <button type="button" class="template-btn" data-template="high-fee">
                                é«˜è´¹ç”¨ (3% / 7%)
                            </button>
                        </div>
                    </div>

                    <!-- è´¹ç”¨ä¿¡æ¯ -->
                    <div class="fee-info">
                        <div class="fee-item">
                            <span>åˆ›å»ºè´¹ç”¨:</span>
                            <span id="creationFee">0.03 BNB</span>
                        </div>
                        <div class="fee-item">
                            <span>é¢„ä¼°Gasè´¹:</span>
                            <span id="estimatedGas">~0.01 BNB</span>
                        </div>
                        <div class="fee-item total">
                            <span>æ€»è´¹ç”¨:</span>
                            <span id="totalFee">~0.04 BNB</span>
                        </div>
                    </div>

                    <button type="submit" class="create-btn" id="createBtn">
                        <span class="btn-text">åˆ›å»ºä»£å¸</span>
                        <span class="btn-loader" style="display: none;">â³ åˆ›å»ºä¸­...</span>
                    </button>
                </form>
            </div>

            <!-- äº¤æ˜“çŠ¶æ€ -->
            <div class="transaction-card" id="transactionCard" style="display: none;">
                <h3>äº¤æ˜“çŠ¶æ€</h3>
                <div class="transaction-status" id="transactionStatus">
                    <div class="status-step active" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-text">ç¡®è®¤äº¤æ˜“</div>
                    </div>
                    <div class="status-step" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-text">ç­‰å¾…ç¡®è®¤</div>
                    </div>
                    <div class="status-step" id="step3">
                        <div class="step-icon">3</div>
                        <div class="step-text">åˆ›å»ºå®Œæˆ</div>
                    </div>
                </div>
                <div class="transaction-details" id="transactionDetails">
                    <div class="detail-item">
                        <span>äº¤æ˜“å“ˆå¸Œ:</span>
                        <a href="#" target="_blank" id="txHash">-</a>
                    </div>
                    <div class="detail-item">
                        <span>ä»£å¸åœ°å€:</span>
                        <a href="#" target="_blank" id="tokenAddress">-</a>
                        <button id="retryAddressBtn" onclick="manualRetryAddress()" style="display: none; margin-left: 10px; padding: 4px 8px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ”„ é‡è¯•è·å–</button>
                    </div>
                    <div class="detail-item">
                        <span>Gasä½¿ç”¨:</span>
                        <span id="gasUsed">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="footer">
            <a href="https://testnet.bscscan.com" target="_blank">BSCScanæµ‹è¯•ç½‘</a>
            <a href="https://testnet.binance.org/faucet-smart" target="_blank">è·å–æµ‹è¯•BNB</a>
            <a href="#" onclick="showHelp()">ä½¿ç”¨å¸®åŠ©</a>
            <br><br>
            <small>å·¥å‚åˆçº¦: <a href="https://testnet.bscscan.com/address/0x073faD54A73333EC1671522b9cCCbbBd153DA265" target="_blank">0x073f...A265</a> | BSCæµ‹è¯•ç½‘ (Chain ID: 97)</small>
        </div>
    </div>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div class="modal" id="helpModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä½¿ç”¨å¸®åŠ©</h3>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <h4>1. è¿æ¥MetaMask</h4>
                <p>ç‚¹å‡»"è¿æ¥é’±åŒ…"æŒ‰é’®ï¼Œé€‰æ‹©MetaMaskå¹¶æˆæƒè¿æ¥ã€‚</p>

                <h4>2. é…ç½®BSCæµ‹è¯•ç½‘</h4>
                <p>ç¡®ä¿MetaMaskå·²æ·»åŠ BSCæµ‹è¯•ç½‘ç»œï¼š</p>
                <ul>
                    <li>ç½‘ç»œåç§°: BSC Testnet</li>
                    <li>RPC URL: https://data-seed-prebsc-1-s1.binance.org:8545/</li>
                    <li>Chain ID: 97</li>
                    <li>ç¬¦å·: BNB</li>
                </ul>

                <h4>3. è·å–æµ‹è¯•BNB</h4>
                <p>è®¿é—® <a href="https://testnet.binance.org/faucet-smart" target="_blank">BSCæµ‹è¯•ç½‘æ°´é¾™å¤´</a> è·å–å…è´¹çš„æµ‹è¯•BNBã€‚</p>

                <h4>4. åˆ›å»ºä»£å¸</h4>
                <p>å¡«å†™ä»£å¸ä¿¡æ¯ï¼Œç¡®è®¤äº¤æ˜“ï¼Œç­‰å¾…åŒºå—é“¾ç¡®è®¤å³å¯ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_CONFIG = {
            FACTORY_ADDRESS: '0x073faD54A73333EC1671522b9cCCbbBd153DA265',
            BSC_TESTNET_CHAIN_ID: 97,
            BSC_TESTNET_RPC: 'https://data-seed-prebsc-1-s1.binance.org:8545/',
            BSCSCAN_BASE_URL: 'https://testnet.bscscan.com'
        };

        // å·¥å‚åˆçº¦ABI
        const FACTORY_ABI = [
            "function createToken(string memory name, string memory symbol, uint256 totalSupply, uint256 buyFee, uint256 sellFee) external payable returns (address)",
            "function creationFee() external view returns (uint256)",
            "event TokenCreated(address indexed creator, address indexed token, string name, string symbol)"
        ];

        // å…¨å±€å˜é‡
        let provider;
        let signer;
        let factory;
        let userAddress;

        // æ˜¾ç¤ºåº“åŠ è½½é”™è¯¯
        function showLibraryError() {
            updateStatus('âŒ', 'åº“åŠ è½½å¤±è´¥', 'Ethers.js åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = 'åº“åŠ è½½å¤±è´¥';

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            console.error('ğŸ” è°ƒè¯•ä¿¡æ¯:');
            console.error('- ethers å¯¹è±¡:', typeof ethers);
            console.error('- window.ethereum:', typeof window.ethereum);
            console.error('- ç”¨æˆ·ä»£ç†:', navigator.userAgent);
        }

        // æ˜¾ç¤ºåº“åŠ è½½æˆåŠŸä¿¡æ¯
        function showLibrarySuccess() {
            console.log('ğŸ” åº“åŠ è½½æˆåŠŸä¿¡æ¯:');
            console.log('- ethers ç‰ˆæœ¬:', ethers.version);
            console.log('- ethers å¯¹è±¡:', ethers);
            console.log('- window.ethereum:', typeof window.ethereum);
        }

        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
        function checkLibraryLoaded() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’è¶…æ—¶

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (typeof ethers !== 'undefined') {
                        clearInterval(checkInterval);
                        console.log('âœ… Ethers.js åº“åŠ è½½æˆåŠŸ');
                        showLibrarySuccess();
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('âŒ Ethers.js åº“åŠ è½½è¶…æ—¶');
                        showLibraryError();
                        resolve(false);
                    }
                }, 100);
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function init() {
            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (window.appInitialized) {
                console.log('ğŸ“„ åº”ç”¨å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡');
                return;
            }

            console.log('ğŸ“„ å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');

            // é¦–å…ˆæ£€æŸ¥åº“æ˜¯å¦åŠ è½½
            const libraryLoaded = await checkLibraryLoaded();
            if (!libraryLoaded) {
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                showError('è¯·å®‰è£…MetaMaské’±åŒ…');
                return;
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('tokenForm').addEventListener('submit', createToken);

            // æ¨¡æ¿æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', applyTemplate);
            });

            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
            if (window.ethereum.selectedAddress) {
                await connectWallet();
            }

            // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
            window.appInitialized = true;
            console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                // å†æ¬¡æ£€æŸ¥ ethers æ˜¯å¦å¯ç”¨
                if (typeof ethers === 'undefined') {
                    throw new Error('Ethers.js åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }

                updateStatus('ğŸ”„', 'è¿æ¥ä¸­...', 'æ­£åœ¨è¿æ¥MetaMaské’±åŒ…');

                // æ£€æŸ¥ MetaMask æ˜¯å¦å¯ç”¨
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== CONTRACT_CONFIG.BSC_TESTNET_CHAIN_ID) {
                    await switchToBSCTestnet();
                    return;
                }

                // è·å–ä½™é¢
                const balance = await provider.getBalance(userAddress);
                const balanceInBNB = ethers.utils.formatEther(balance);

                // åˆå§‹åŒ–å·¥å‚åˆçº¦
                factory = new ethers.Contract(CONTRACT_CONFIG.FACTORY_ADDRESS, FACTORY_ABI, signer);

                // æ›´æ–°UI
                updateStatus('âœ…', 'é’±åŒ…å·²è¿æ¥', `å·²è¿æ¥åˆ°BSCæµ‹è¯•ç½‘`);
                document.getElementById('walletAddress').textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
                document.getElementById('walletBalance').textContent = `${parseFloat(balanceInBNB).toFixed(4)} BNB`;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('formCard').style.display = 'block';

                // è·å–åˆ›å»ºè´¹ç”¨
                try {
                    const creationFee = await factory.creationFee();
                    document.getElementById('creationFee').textContent = `${ethers.utils.formatEther(creationFee)} BNB`;
                } catch (error) {
                    console.error('è·å–åˆ›å»ºè´¹ç”¨å¤±è´¥:', error);
                }

            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showError(`è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // åˆ‡æ¢åˆ°BSCæµ‹è¯•ç½‘
        async function switchToBSCTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x61' }], // 97 in hex
                });
                await connectWallet();
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x61',
                                chainName: 'BSC Testnet',
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                                blockExplorerUrls: ['https://testnet.bscscan.com/']
                            }]
                        });
                        await connectWallet();
                    } catch (addError) {
                        showError('æ·»åŠ BSCæµ‹è¯•ç½‘å¤±è´¥');
                    }
                } else {
                    showError('åˆ‡æ¢ç½‘ç»œå¤±è´¥');
                }
            }
        }

        // åº”ç”¨æ¨¡æ¿
        function applyTemplate(event) {
            const template = event.target.dataset.template;
            const templates = {
                'standard': { buyFee: 1, sellFee: 3 },
                'low-fee': { buyFee: 0.5, sellFee: 1 },
                'high-fee': { buyFee: 3, sellFee: 7 }
            };

            if (templates[template]) {
                document.getElementById('buyFee').value = templates[template].buyFee;
                document.getElementById('sellFee').value = templates[template].sellFee;
            }
        }

        // åˆ›å»ºä»£å¸
        async function createToken(event) {
            event.preventDefault();

            try {
                const name = document.getElementById('tokenName').value;
                const symbol = document.getElementById('tokenSymbol').value;
                const totalSupply = document.getElementById('totalSupply').value;
                const buyFee = document.getElementById('buyFee').value || 0;
                const sellFee = document.getElementById('sellFee').value || 0;

                if (!name || !symbol || !totalSupply) {
                    showError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                    return;
                }

                // æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€
                document.getElementById('transactionCard').style.display = 'block';
                updateTransactionStep(1);

                // ç¦ç”¨æŒ‰é’®
                const createBtn = document.getElementById('createBtn');
                createBtn.disabled = true;
                document.querySelector('.btn-text').style.display = 'none';
                document.querySelector('.btn-loader').style.display = 'inline';

                // è·å–åˆ›å»ºè´¹ç”¨
                const creationFee = await factory.creationFee();

                // åˆ›å»ºä»£å¸
                const tx = await factory.createToken(
                    name,
                    symbol,
                    totalSupply,
                    Math.floor(parseFloat(buyFee) * 10) / 10,
                    Math.floor(parseFloat(sellFee) * 10) / 10,
                    { value: creationFee }
                );

                // æ›´æ–°äº¤æ˜“å“ˆå¸Œ
                document.getElementById('txHash').textContent = `${tx.hash.slice(0,10)}...${tx.hash.slice(-8)}`;
                document.getElementById('txHash').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}`;

                // ä¿å­˜äº¤æ˜“ä¿¡æ¯ä¾›é‡è¯•ä½¿ç”¨
                currentTxHash = tx.hash;
                currentTokenData = { name, symbol, totalSupply, buyFee, sellFee };

                updateTransactionStep(2);

                // ç­‰å¾…ç¡®è®¤
                const receipt = await tx.wait();
                console.log('äº¤æ˜“å›æ‰§:', receipt);

                // å¤šç§æ–¹æ³•è§£æTokenCreatedäº‹ä»¶
                let tokenAddress = null;
                let parseMethod = '';

                // æ–¹æ³•1: ä½¿ç”¨receipt.events (ethers v5é£æ ¼)
                if (receipt.events && receipt.events.length > 0) {
                    console.log('å°è¯•æ–¹æ³•1: receipt.events');
                    const tokenCreatedEvent = receipt.events.find(
                        event => event.event === 'TokenCreated'
                    );
                    if (tokenCreatedEvent && tokenCreatedEvent.args) {
                        tokenAddress = tokenCreatedEvent.args.token;
                        parseMethod = 'receipt.events';
                        console.log('æ–¹æ³•1æˆåŠŸï¼Œä»£å¸åœ°å€:', tokenAddress);
                    }
                }

                // æ–¹æ³•2: ä½¿ç”¨åˆçº¦æ¥å£è§£ææ—¥å¿—
                if (!tokenAddress && receipt.logs && receipt.logs.length > 0) {
                    console.log('å°è¯•æ–¹æ³•2: åˆçº¦æ¥å£è§£ææ—¥å¿—');
                    try {
                        const iface = new ethers.utils.Interface(FACTORY_ABI);
                        for (const log of receipt.logs) {
                            try {
                                const parsedLog = iface.parseLog(log);
                                console.log('è§£æçš„æ—¥å¿—:', parsedLog);
                                if (parsedLog.name === 'TokenCreated') {
                                    tokenAddress = parsedLog.args.token;
                                    parseMethod = 'åˆçº¦æ¥å£è§£æ';
                                    console.log('æ–¹æ³•2æˆåŠŸï¼Œä»£å¸åœ°å€:', tokenAddress);
                                    break;
                                }
                            } catch (logError) {
                                // å¿½ç•¥æ— æ³•è§£æçš„æ—¥å¿—
                                console.log('è·³è¿‡æ— æ³•è§£æçš„æ—¥å¿—:', logError.message);
                            }
                        }
                    } catch (error) {
                        console.error('æ¥å£è§£æå¤±è´¥:', error);
                    }
                }

                // æ–¹æ³•3: æ‰‹åŠ¨è§£ææ—¥å¿—æ•°æ®
                if (!tokenAddress && receipt.logs && receipt.logs.length > 0) {
                    console.log('å°è¯•æ–¹æ³•3: æ‰‹åŠ¨è§£ææ—¥å¿—');
                    try {
                        // TokenCreatedäº‹ä»¶çš„ç­¾åå“ˆå¸Œ
                        const tokenCreatedTopic = ethers.utils.id('TokenCreated(address,address,string,string)');
                        console.log('TokenCreatedäº‹ä»¶ç­¾å:', tokenCreatedTopic);

                        for (const log of receipt.logs) {
                            console.log('æ£€æŸ¥æ—¥å¿—:', log);
                            if (log.topics && log.topics[0] === tokenCreatedTopic) {
                                // ç¬¬äºŒä¸ªtopicæ˜¯tokenåœ°å€ (indexedå‚æ•°)
                                if (log.topics.length >= 3) {
                                    tokenAddress = ethers.utils.getAddress('0x' + log.topics[2].slice(26));
                                    parseMethod = 'æ‰‹åŠ¨è§£ææ—¥å¿—';
                                    console.log('æ–¹æ³•3æˆåŠŸï¼Œä»£å¸åœ°å€:', tokenAddress);
                                    break;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('æ‰‹åŠ¨è§£æå¤±è´¥:', error);
                    }
                }

                // æ˜¾ç¤ºè§£æç»“æœ
                if (tokenAddress) {
                    console.log(`âœ… æˆåŠŸè·å–ä»£å¸åœ°å€: ${tokenAddress} (ä½¿ç”¨${parseMethod})`);

                    // æ›´æ–°UI
                    document.getElementById('tokenAddress').textContent = `${tokenAddress.slice(0,10)}...${tokenAddress.slice(-8)}`;
                    document.getElementById('tokenAddress').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}`;
                    document.getElementById('gasUsed').textContent = receipt.gasUsed.toString();

                    updateTransactionStep(3);

                    // æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯
                    showSuccess(`
                        <div style="text-align: left;">
                            <div><strong>ğŸ‰ ä»£å¸åˆ›å»ºæˆåŠŸï¼</strong></div>
                            <div style="margin-top: 8px;">
                                <strong>ä»£å¸ä¿¡æ¯:</strong><br>
                                åç§°: ${name}<br>
                                ç¬¦å·: ${symbol}<br>
                                æ€»ä¾›åº”é‡: ${totalSupply}<br>
                                ä¹°å…¥æ‰‹ç»­è´¹: ${buyFee}%<br>
                                å–å‡ºæ‰‹ç»­è´¹: ${sellFee}%
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>åˆçº¦åœ°å€:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tokenAddress}
                                </a>
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>äº¤æ˜“å“ˆå¸Œ:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tx.hash}
                                </a>
                            </div>
                        </div>
                    `);

                    // ä¿å­˜åˆ°å†å²è®°å½•
                    saveToHistory({
                        name, symbol, totalSupply, buyFee, sellFee,
                        tokenAddress, txHash: tx.hash,
                        timestamp: new Date().toISOString()
                    });

                } else {
                    console.error('âŒ åˆæ¬¡è§£æå¤±è´¥ï¼Œå¼€å§‹é‡è¯•...');
                    console.log('äº¤æ˜“å›æ‰§è¯¦æƒ…:', JSON.stringify(receipt, null, 2));

                    // æ˜¾ç¤ºé‡è¯•çŠ¶æ€
                    updateStatus('ğŸ”„', 'é‡è¯•ä¸­', 'æ­£åœ¨å°è¯•é‡æ–°è·å–ä»£å¸åœ°å€...');

                    // å°è¯•é‡è¯•è·å–ä»£å¸åœ°å€
                    const retryTokenAddress = await retryGetTokenAddress(tx.hash);

                    if (retryTokenAddress) {
                        console.log(`âœ… é‡è¯•æˆåŠŸï¼è·å–åˆ°ä»£å¸åœ°å€: ${retryTokenAddress}`);

                        // æ›´æ–°UI
                        document.getElementById('tokenAddress').textContent = `${retryTokenAddress.slice(0,10)}...${retryTokenAddress.slice(-8)}`;
                        document.getElementById('tokenAddress').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${retryTokenAddress}`;
                        document.getElementById('gasUsed').textContent = receipt.gasUsed.toString();

                        updateTransactionStep(3);

                        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                        showSuccess(`
                            <div style="text-align: left;">
                                <div><strong>ğŸ‰ ä»£å¸åˆ›å»ºæˆåŠŸï¼(é‡è¯•è·å–)</strong></div>
                                <div style="margin-top: 8px;">
                                    <strong>ä»£å¸ä¿¡æ¯:</strong><br>
                                    åç§°: ${name}<br>
                                    ç¬¦å·: ${symbol}<br>
                                    æ€»ä¾›åº”é‡: ${totalSupply}<br>
                                    ä¹°å…¥æ‰‹ç»­è´¹: ${buyFee}%<br>
                                    å–å‡ºæ‰‹ç»­è´¹: ${sellFee}%
                                </div>
                                <div style="margin-top: 8px;">
                                    <strong>åˆçº¦åœ°å€:</strong><br>
                                    <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${retryTokenAddress}" target="_blank" style="color: #007bff; text-decoration: none;">
                                        ${retryTokenAddress}
                                    </a>
                                </div>
                                <div style="margin-top: 8px;">
                                    <strong>äº¤æ˜“å“ˆå¸Œ:</strong><br>
                                    <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                        ${tx.hash}
                                    </a>
                                </div>
                            </div>
                        `);

                        // ä¿å­˜åˆ°å†å²è®°å½•
                        saveToHistory({
                            name, symbol, totalSupply, buyFee, sellFee,
                            tokenAddress: retryTokenAddress, txHash: tx.hash,
                            timestamp: new Date().toISOString()
                        });

                    } else {
                        console.error('âŒ é‡è¯•ä¹Ÿå¤±è´¥äº†ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨æŸ¥çœ‹æŒ‡å¼•');

                        // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
                        showError(`
                            <div style="text-align: left;">
                                <div><strong>âš ï¸ ä»£å¸åˆ›å»ºæˆåŠŸï¼Œä½†æ— æ³•è‡ªåŠ¨è·å–åœ°å€</strong></div>
                                <div style="margin-top: 8px;">
                                    äº¤æ˜“å·²æˆåŠŸæ‰§è¡Œï¼Œä½†å‰ç«¯æ— æ³•è§£æäº‹ä»¶æ—¥å¿—ã€‚<br>
                                    <strong>å·²å°è¯•å¤šç§è§£ææ–¹æ³•å’Œé‡è¯•æœºåˆ¶ã€‚</strong><br>
                                    è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ä»£å¸ä¿¡æ¯ï¼š
                                </div>
                                <div style="margin-top: 8px;">
                                    <strong>1. æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…:</strong><br>
                                    <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${tx.hash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                        ${tx.hash}
                                    </a>
                                </div>
                                <div style="margin-top: 8px;">
                                    <strong>2. åœ¨BSCScanä¸­:</strong><br>
                                    â€¢ ç‚¹å‡»ä¸Šæ–¹äº¤æ˜“é“¾æ¥<br>
                                    â€¢ æŸ¥çœ‹ "To" å­—æ®µä¸­çš„åˆçº¦åœ°å€<br>
                                    â€¢ æˆ–åœ¨ "Logs" æ ‡ç­¾é¡µä¸­æ‰¾åˆ°TokenCreatedäº‹ä»¶<br>
                                    â€¢ ä»£å¸åœ°å€åœ¨äº‹ä»¶çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­
                                </div>
                                <div style="margin-top: 8px;">
                                    <strong>3. è°ƒè¯•ä¿¡æ¯:</strong><br>
                                    Gasä½¿ç”¨é‡: ${receipt.gasUsed.toString()}<br>
                                    æ—¥å¿—æ•°é‡: ${receipt.logs ? receipt.logs.length : 0}
                                </div>
                                <div style="margin-top: 8px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; font-size: 12px;">
                                    <strong>æŠ€æœ¯è¯´æ˜:</strong> è¿™é€šå¸¸æ˜¯ç”±äºç½‘ç»œå»¶è¿Ÿæˆ–äº‹ä»¶è§£æé—®é¢˜å¯¼è‡´çš„ã€‚ä»£å¸å·²æˆåŠŸåˆ›å»ºï¼Œåªæ˜¯å‰ç«¯æ— æ³•è‡ªåŠ¨è·å–åœ°å€ã€‚
                                </div>
                            </div>
                        `);

                        // ä»ç„¶æ›´æ–°äº¤æ˜“æ­¥éª¤ï¼Œæ˜¾ç¤ºéƒ¨åˆ†ä¿¡æ¯
                        document.getElementById('gasUsed').textContent = receipt.gasUsed.toString();
                        updateTransactionStep(3);

                        // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
                        document.getElementById('retryAddressBtn').style.display = 'inline-block';
                    }
                }

            } catch (error) {
                console.error('åˆ›å»ºä»£å¸å¤±è´¥:', error);
                showError(`åˆ›å»ºå¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®
                const createBtn = document.getElementById('createBtn');
                createBtn.disabled = false;
                document.querySelector('.btn-text').style.display = 'inline';
                document.querySelector('.btn-loader').style.display = 'none';
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(icon, title, desc) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusTitle').textContent = title;

            // æ”¯æŒHTMLå†…å®¹
            const descElement = document.getElementById('statusDesc');
            if (desc.includes('<')) {
                descElement.innerHTML = desc;
            } else {
                descElement.textContent = desc;
            }
        }

        // æ›´æ–°äº¤æ˜“æ­¥éª¤
        function updateTransactionStep(step) {
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (i < step) {
                    stepElement.className = 'status-step completed';
                } else if (i === step) {
                    stepElement.className = 'status-step active';
                } else {
                    stepElement.className = 'status-step';
                }
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            updateStatus('âŒ', 'é”™è¯¯', message);
        }

        // æ˜¾ç¤ºæˆåŠŸ
        function showSuccess(message) {
            updateStatus('ğŸ‰', 'æˆåŠŸ', message);
        }

        // é‡è¯•è·å–ä»£å¸åœ°å€ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
        async function retryGetTokenAddress(txHash, maxRetries = 3) {
            console.log(`ğŸ”„ å¼€å§‹é‡è¯•è·å–ä»£å¸åœ°å€ï¼Œäº¤æ˜“å“ˆå¸Œ: ${txHash}`);

            for (let i = 0; i < maxRetries; i++) {
                try {
                    console.log(`å°è¯•ç¬¬ ${i + 1} æ¬¡...`);

                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡æ–°è·å–äº¤æ˜“å›æ‰§
                    await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));

                    const receipt = await provider.getTransactionReceipt(txHash);
                    if (!receipt) {
                        console.log('äº¤æ˜“å›æ‰§ä¸å­˜åœ¨ï¼Œç»§ç»­é‡è¯•...');
                        continue;
                    }

                    console.log(`é‡è¯• ${i + 1}: è·å–åˆ°äº¤æ˜“å›æ‰§`, receipt);

                    // ä½¿ç”¨ç›¸åŒçš„è§£æé€»è¾‘
                    if (receipt.logs && receipt.logs.length > 0) {
                        try {
                            const iface = new ethers.utils.Interface(FACTORY_ABI);
                            for (const log of receipt.logs) {
                                try {
                                    const parsedLog = iface.parseLog(log);
                                    if (parsedLog.name === 'TokenCreated') {
                                        const tokenAddress = parsedLog.args.token;
                                        console.log(`âœ… é‡è¯•æˆåŠŸï¼è·å–åˆ°ä»£å¸åœ°å€: ${tokenAddress}`);
                                        return tokenAddress;
                                    }
                                } catch (logError) {
                                    // å¿½ç•¥æ— æ³•è§£æçš„æ—¥å¿—
                                }
                            }
                        } catch (error) {
                            console.error(`é‡è¯• ${i + 1} æ¥å£è§£æå¤±è´¥:`, error);
                        }

                        // æ‰‹åŠ¨è§£ææ–¹æ³•
                        try {
                            const tokenCreatedTopic = ethers.utils.id('TokenCreated(address,address,string,string)');
                            for (const log of receipt.logs) {
                                if (log.topics && log.topics[0] === tokenCreatedTopic && log.topics.length >= 3) {
                                    const tokenAddress = ethers.utils.getAddress('0x' + log.topics[2].slice(26));
                                    console.log(`âœ… é‡è¯•æ‰‹åŠ¨è§£ææˆåŠŸï¼è·å–åˆ°ä»£å¸åœ°å€: ${tokenAddress}`);
                                    return tokenAddress;
                                }
                            }
                        } catch (error) {
                            console.error(`é‡è¯• ${i + 1} æ‰‹åŠ¨è§£æå¤±è´¥:`, error);
                        }
                    }

                } catch (error) {
                    console.error(`é‡è¯• ${i + 1} å¤±è´¥:`, error);
                }
            }

            console.log('âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†');
            return null;
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(tokenData) {
            const history = JSON.parse(localStorage.getItem('tokenHistory') || '[]');
            history.unshift(tokenData);
            localStorage.setItem('tokenHistory', JSON.stringify(history.slice(0, 10))); // åªä¿ç•™æœ€è¿‘10ä¸ª
        }

        // æ‰‹åŠ¨é‡è¯•è·å–ä»£å¸åœ°å€
        let currentTxHash = null; // å­˜å‚¨å½“å‰äº¤æ˜“å“ˆå¸Œ
        let currentTokenData = null; // å­˜å‚¨å½“å‰ä»£å¸æ•°æ®

        async function manualRetryAddress() {
            if (!currentTxHash) {
                showError('æ²¡æœ‰å¯é‡è¯•çš„äº¤æ˜“');
                return;
            }

            console.log('ğŸ”„ ç”¨æˆ·æ‰‹åŠ¨é‡è¯•è·å–ä»£å¸åœ°å€');

            // ç¦ç”¨é‡è¯•æŒ‰é’®
            const retryBtn = document.getElementById('retryAddressBtn');
            retryBtn.disabled = true;
            retryBtn.textContent = 'ğŸ”„ é‡è¯•ä¸­...';

            // æ˜¾ç¤ºé‡è¯•çŠ¶æ€
            updateStatus('ğŸ”„', 'é‡è¯•ä¸­', 'æ­£åœ¨é‡æ–°è·å–ä»£å¸åœ°å€...');

            try {
                const tokenAddress = await retryGetTokenAddress(currentTxHash, 5); // å¢åŠ é‡è¯•æ¬¡æ•°

                if (tokenAddress) {
                    console.log(`âœ… æ‰‹åŠ¨é‡è¯•æˆåŠŸï¼è·å–åˆ°ä»£å¸åœ°å€: ${tokenAddress}`);

                    // æ›´æ–°UI
                    document.getElementById('tokenAddress').textContent = `${tokenAddress.slice(0,10)}...${tokenAddress.slice(-8)}`;
                    document.getElementById('tokenAddress').href = `${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}`;

                    // éšè—é‡è¯•æŒ‰é’®
                    retryBtn.style.display = 'none';

                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    showSuccess(`
                        <div style="text-align: left;">
                            <div><strong>ğŸ‰ æ‰‹åŠ¨é‡è¯•æˆåŠŸï¼</strong></div>
                            <div style="margin-top: 8px;">
                                <strong>ä»£å¸åœ°å€:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/address/${tokenAddress}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${tokenAddress}
                                </a>
                            </div>
                            <div style="margin-top: 8px;">
                                <strong>äº¤æ˜“å“ˆå¸Œ:</strong><br>
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${currentTxHash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${currentTxHash}
                                </a>
                            </div>
                        </div>
                    `);

                    // ä¿å­˜åˆ°å†å²è®°å½•
                    if (currentTokenData) {
                        saveToHistory({
                            ...currentTokenData,
                            tokenAddress,
                            txHash: currentTxHash,
                            timestamp: new Date().toISOString()
                        });
                    }

                } else {
                    console.error('âŒ æ‰‹åŠ¨é‡è¯•ä¹Ÿå¤±è´¥äº†');
                    showError(`
                        <div style="text-align: left;">
                            <div><strong>âŒ é‡è¯•å¤±è´¥</strong></div>
                            <div style="margin-top: 8px;">
                                å¤šæ¬¡å°è¯•ä»æ— æ³•è‡ªåŠ¨è·å–ä»£å¸åœ°å€ã€‚<br>
                                è¯·æ‰‹åŠ¨åœ¨BSCScanä¸­æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…ï¼š
                            </div>
                            <div style="margin-top: 8px;">
                                <a href="${CONTRACT_CONFIG.BSCSCAN_BASE_URL}/tx/${currentTxHash}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    æŸ¥çœ‹äº¤æ˜“è¯¦æƒ… â†’
                                </a>
                            </div>
                        </div>
                    `);

                    // é‡æ–°å¯ç”¨é‡è¯•æŒ‰é’®
                    retryBtn.disabled = false;
                    retryBtn.textContent = 'ğŸ”„ é‡è¯•è·å–';
                }

            } catch (error) {
                console.error('æ‰‹åŠ¨é‡è¯•å‡ºé”™:', error);
                showError(`é‡è¯•å¤±è´¥: ${error.message}`);

                // é‡æ–°å¯ç”¨é‡è¯•æŒ‰é’®
                retryBtn.disabled = false;
                retryBtn.textContent = 'ğŸ”„ é‡è¯•è·å–';
            }
        }

        // æ˜¾ç¤ºå¸®åŠ©
        function showHelp() {
            document.getElementById('helpModal').style.display = 'flex';
        }

        // å…³é—­å¸®åŠ©
        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            init();
        });

        // DOM å†…å®¹åŠ è½½å®Œæˆæ—¶ä¹Ÿå°è¯•åˆå§‹åŒ–ï¼ˆå¤‡ç”¨ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOM å†…å®¹åŠ è½½å®Œæˆ');
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿è„šæœ¬åŠ è½½
            setTimeout(function() {
                if (typeof ethers !== 'undefined' && !window.appInitialized) {
                    console.log('ğŸ“„ é€šè¿‡ DOMContentLoaded åˆå§‹åŒ–åº”ç”¨');
                    window.appInitialized = true;
                    init();
                }
            }, 500);
        });

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }
    </script>
</body>
</html>
