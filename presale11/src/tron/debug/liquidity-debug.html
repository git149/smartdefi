<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„å”®æµåŠ¨æ€§é—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .status.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .status.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .result-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .result-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .issue-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
        }
        .issue-item.critical {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        .issue-item.warning {
            border-left-color: #f39c12;
            background: #fef9e7;
        }
        .issue-item.info {
            border-left-color: #3498db;
            background: #f0f8ff;
        }
        .solution-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }
        .solution-steps {
            margin: 10px 0;
            padding-left: 20px;
        }
        .solution-steps li {
            margin: 5px 0;
        }
        .loading {
            text-align: center;
            color: #7f8c8d;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .copy-button {
            background: #95a5a6;
            font-size: 12px;
            padding: 5px 10px;
            margin-left: 10px;
        }
        .copy-button:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é¢„å”®æµåŠ¨æ€§é—®é¢˜è¯Šæ–­å·¥å…·</h1>
        
        <div class="input-group">
            <label for="presaleAddress">é¢„å”®åˆçº¦åœ°å€:</label>
            <input type="text" id="presaleAddress" placeholder="è¾“å…¥é¢„å”®åˆçº¦åœ°å€ (ä¾‹å¦‚: TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t)" />
        </div>
        
        <div class="button-group">
            <button onclick="runDiagnostic()" id="diagnosticBtn">ğŸ” å¼€å§‹è¯Šæ–­</button>
            <button onclick="clearResults()" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        </div>
        
        <div id="status" class="status info" style="display: none;">
            <div id="statusText"></div>
        </div>
        
        <div id="results" style="display: none;">
            <!-- è¯Šæ–­ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let diagnosticResults = null;
        
        // è¿è¡Œè¯Šæ–­
        async function runDiagnostic() {
            const presaleAddress = document.getElementById('presaleAddress').value.trim();
            
            if (!presaleAddress) {
                showStatus('è¯·è¾“å…¥é¢„å”®åˆçº¦åœ°å€', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showStatus('æ­£åœ¨æ‰§è¡Œè¯Šæ–­ï¼Œè¯·ç¨å€™...', 'info');
            document.getElementById('diagnosticBtn').disabled = true;
            
            try {
                // æ£€æŸ¥ TronWeb æ˜¯å¦å¯ç”¨
                if (typeof window.tronWeb === 'undefined') {
                    throw new Error('TronWeb æœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥ TronLink é’±åŒ…');
                }
                
                // æ‰§è¡Œè¯Šæ–­
                const results = await performDiagnostic(presaleAddress);
                diagnosticResults = results;
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(results);
                showStatus('è¯Šæ–­å®Œæˆï¼', 'success');
                
            } catch (error) {
                console.error('è¯Šæ–­å¤±è´¥:', error);
                showStatus(`è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('diagnosticBtn').disabled = false;
            }
        }
        
        // æ‰§è¡Œè¯Šæ–­é€»è¾‘
        async function performDiagnostic(presaleAddress) {
            console.log('ğŸ” å¼€å§‹æ‰§è¡Œè¯Šæ–­...', presaleAddress);
            
            const results = {
                presaleAddress,
                timestamp: new Date().toISOString(),
                presaleStatus: null,
                tokenStatus: null,
                factoryStatus: null,
                balanceStatus: null,
                issues: [],
                solutions: []
            };
            
            try {
                // 1. æ£€æŸ¥é¢„å”®çŠ¶æ€
                results.presaleStatus = await checkPresaleStatus(presaleAddress);
                
                // 2. æ£€æŸ¥ä»£å¸çŠ¶æ€
                results.tokenStatus = await checkTokenStatus(presaleAddress);
                
                // 3. æ£€æŸ¥å·¥å‚æˆæƒçŠ¶æ€
                results.factoryStatus = await checkFactoryStatus(presaleAddress);
                
                // 4. æ£€æŸ¥åˆçº¦ä½™é¢
                results.balanceStatus = await checkContractBalances(presaleAddress);
                
                // 5. åˆ†æé—®é¢˜
                results.issues = analyzeIssues(results);
                
                // 6. ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
                results.solutions = generateSolutions(results.issues);
                
            } catch (error) {
                console.error('è¯Šæ–­è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                results.error = error.message;
            }
            
            return results;
        }
        
        // æ£€æŸ¥é¢„å”®çŠ¶æ€
        async function checkPresaleStatus(presaleAddress) {
            try {
                const contract = await window.tronWeb.contract().at(presaleAddress);
                
                const [presaleStatus, isFinalized, autoEnabled, liquidityAdded] = await Promise.all([
                    contract.presaleStatus().call(),
                    contract.presaleFinalized().call(),
                    contract.autoFinalizationEnabled().call(),
                    contract.liquidityAdded().call()
                ]);
                
                return {
                    presaleStatus: Number(presaleStatus),
                    presaleStatusText: getPresaleStatusText(Number(presaleStatus)),
                    isFinalized: Boolean(isFinalized),
                    autoEnabled: Boolean(autoEnabled),
                    liquidityAdded: Boolean(liquidityAdded)
                };
            } catch (error) {
                console.error('æ£€æŸ¥é¢„å”®çŠ¶æ€å¤±è´¥:', error);
                return { error: error.message };
            }
        }
        
        // æ£€æŸ¥ä»£å¸çŠ¶æ€
        async function checkTokenStatus(presaleAddress) {
            try {
                const contract = await window.tronWeb.contract().at(presaleAddress);
                const tokenAddress = await contract.coinAddress().call();
                
                if (tokenAddress === 'T9yD14Nj9j7xAB4dbGeiX9h8ekKHpVp9C') { // é›¶åœ°å€
                    return { error: 'ä»£å¸åœ°å€æœªè®¾ç½®' };
                }
                
                const tokenContract = await window.tronWeb.contract().at(tokenAddress);
                const [name, symbol, decimals, totalSupply] = await Promise.all([
                    tokenContract.name().call(),
                    tokenContract.symbol().call(),
                    tokenContract.decimals().call(),
                    tokenContract.totalSupply().call()
                ]);
                
                return {
                    tokenAddress,
                    tokenName: name,
                    tokenSymbol: symbol,
                    tokenDecimals: Number(decimals),
                    totalSupply: totalSupply
                };
            } catch (error) {
                console.error('æ£€æŸ¥ä»£å¸çŠ¶æ€å¤±è´¥:', error);
                return { error: error.message };
            }
        }
        
        // æ£€æŸ¥å·¥å‚æˆæƒçŠ¶æ€
        async function checkFactoryStatus(presaleAddress) {
            try {
                const contract = await window.tronWeb.contract().at(presaleAddress);
                const [factoryAddress, allowance] = await Promise.all([
                    contract.factoryAddress().call(),
                    contract.getFactoryAllowance().call()
                ]);
                
                if (factoryAddress === 'T9yD14Nj9j7xAB4dbGeiX9h8ekKHpVp9C') { // é›¶åœ°å€
                    return { error: 'å·¥å‚åˆçº¦åœ°å€æœªè®¾ç½®' };
                }
                
                return {
                    factoryAddress,
                    allowance: allowance,
                    allowanceFormatted: window.tronWeb.fromSun(allowance)
                };
            } catch (error) {
                console.error('æ£€æŸ¥å·¥å‚æˆæƒçŠ¶æ€å¤±è´¥:', error);
                return { error: error.message };
            }
        }
        
        // æ£€æŸ¥åˆçº¦ä½™é¢
        async function checkContractBalances(presaleAddress) {
            try {
                const contract = await window.tronWeb.contract().at(presaleAddress);
                const [balances, accumulatedBNB] = await Promise.all([
                    contract.getContractBalances().call(),
                    contract.accumulatedBNB().call()
                ]);
                
                return {
                    tokenBalance: balances.tokenBalance,
                    bnbBalance: balances.bnbBalance,
                    accumulatedBNB: accumulatedBNB,
                    tokenBalanceFormatted: window.tronWeb.fromSun(balances.tokenBalance),
                    bnbBalanceFormatted: window.tronWeb.fromSun(balances.bnbBalance),
                    accumulatedBNBFormatted: window.tronWeb.fromSun(accumulatedBNB)
                };
            } catch (error) {
                console.error('æ£€æŸ¥åˆçº¦ä½™é¢å¤±è´¥:', error);
                return { error: error.message };
            }
        }
        
        // åˆ†æé—®é¢˜
        function analyzeIssues(results) {
            const issues = [];
            
            // æ£€æŸ¥é¢„å”®çŠ¶æ€
            if (results.presaleStatus.error) {
                issues.push({ 
                    type: 'PRESALE_STATUS_ERROR', 
                    message: results.presaleStatus.error,
                    severity: 'critical'
                });
            }
            
            if (results.presaleStatus.presaleStatus < 2) {
                issues.push({ 
                    type: 'PRESALE_NOT_ENDED', 
                    message: `é¢„å”®å°šæœªç»“æŸï¼Œå½“å‰çŠ¶æ€: ${results.presaleStatus.presaleStatusText}`,
                    severity: 'warning'
                });
            }
            
            if (results.presaleStatus.isFinalized) {
                issues.push({ 
                    type: 'PRESALE_ALREADY_FINALIZED', 
                    message: 'é¢„å”®å·²ç»å®Œæˆï¼Œæ— æ³•é‡å¤æ‰§è¡Œ',
                    severity: 'info'
                });
            }
            
            // æ£€æŸ¥ä»£å¸çŠ¶æ€
            if (results.tokenStatus.error) {
                issues.push({ 
                    type: 'TOKEN_STATUS_ERROR', 
                    message: results.tokenStatus.error,
                    severity: 'critical'
                });
            }
            
            // æ£€æŸ¥å·¥å‚æˆæƒ
            if (results.factoryStatus.error) {
                issues.push({ 
                    type: 'FACTORY_STATUS_ERROR', 
                    message: results.factoryStatus.error,
                    severity: 'critical'
                });
            }
            
            if (Number(results.factoryStatus.allowance) === 0) {
                issues.push({ 
                    type: 'NO_FACTORY_ALLOWANCE', 
                    message: 'å·¥å‚åˆçº¦æ²¡æœ‰å¯¹é¢„å”®åˆçº¦çš„ä»£å¸æˆæƒ',
                    severity: 'critical'
                });
            }
            
            // æ£€æŸ¥ä½™é¢
            if (results.balanceStatus.error) {
                issues.push({ 
                    type: 'BALANCE_STATUS_ERROR', 
                    message: results.balanceStatus.error,
                    severity: 'critical'
                });
            }
            
            if (Number(results.balanceStatus.accumulatedBNB) === 0) {
                issues.push({ 
                    type: 'NO_ACCUMULATED_BNB', 
                    message: 'æ²¡æœ‰ç´¯ç§¯çš„BNBç”¨äºæµåŠ¨æ€§',
                    severity: 'warning'
                });
            }
            
            // æ£€æŸ¥å…³é”®é—®é¢˜ï¼šä»£å¸ä½™é¢ä¸è¶³
            if (Number(results.balanceStatus.tokenBalance) === 0 && Number(results.factoryStatus.allowance) > 0) {
                issues.push({ 
                    type: 'TRANSFER_FROM_FAILED_ROOT_CAUSE', 
                    message: 'é¢„å”®åˆçº¦æ²¡æœ‰ä»£å¸ä½™é¢ï¼Œä½†å·¥å‚æœ‰æˆæƒé¢åº¦ - è¿™æ˜¯ TRANSFER_FROM_FAILED çš„æ ¹æœ¬åŸå› ',
                    severity: 'critical'
                });
            }
            
            return issues;
        }
        
        // ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
        function generateSolutions(issues) {
            const solutions = [];
            
            issues.forEach(issue => {
                switch (issue.type) {
                    case 'PRESALE_NOT_ENDED':
                        solutions.push({
                            issue: issue.type,
                            solution: 'ç­‰å¾…é¢„å”®è‡ªç„¶ç»“æŸï¼Œæˆ–æ‰‹åŠ¨è®¾ç½®é¢„å”®çŠ¶æ€ä¸ºå·²ç»“æŸ',
                            action: 'wait_or_manual_end'
                        });
                        break;
                        
                    case 'PRESALE_ALREADY_FINALIZED':
                        solutions.push({
                            issue: issue.type,
                            solution: 'é¢„å”®å·²å®Œæˆï¼Œæ— éœ€é‡å¤æ‰§è¡Œ',
                            action: 'no_action_needed'
                        });
                        break;
                        
                    case 'TOKEN_ADDRESS_INVALID':
                        solutions.push({
                            issue: issue.type,
                            solution: 'æ£€æŸ¥ä»£å¸åˆçº¦åœ°å€é…ç½®ï¼Œç¡®ä¿åœ°å€æ­£ç¡®',
                            action: 'check_token_config'
                        });
                        break;
                        
                    case 'FACTORY_ADDRESS_INVALID':
                        solutions.push({
                            issue: issue.type,
                            solution: 'æ£€æŸ¥å·¥å‚åˆçº¦åœ°å€é…ç½®ï¼Œç¡®ä¿åœ°å€æ­£ç¡®',
                            action: 'check_factory_config'
                        });
                        break;
                        
                    case 'NO_FACTORY_ALLOWANCE':
                        solutions.push({
                            issue: issue.type,
                            solution: 'å·¥å‚åˆçº¦éœ€è¦å…ˆå¯¹é¢„å”®åˆçº¦è¿›è¡Œä»£å¸æˆæƒ',
                            action: 'factory_approve_tokens'
                        });
                        break;
                        
                    case 'NO_ACCUMULATED_BNB':
                        solutions.push({
                            issue: issue.type,
                            solution: 'æ²¡æœ‰BNBç´¯ç§¯ï¼Œæ— æ³•æ·»åŠ æµåŠ¨æ€§',
                            action: 'no_action_possible'
                        });
                        break;
                        
                    case 'TRANSFER_FROM_FAILED_ROOT_CAUSE':
                        solutions.push({
                            issue: issue.type,
                            solution: 'å·¥å‚åˆçº¦ä¸­ä»£å¸ä½™é¢ä¸è¶³ï¼Œéœ€è¦å…ˆå‘å·¥å‚åˆçº¦è½¬å…¥è¶³å¤Ÿçš„ä»£å¸',
                            action: 'transfer_tokens_to_factory',
                            steps: [
                                '1. æ£€æŸ¥å·¥å‚åˆçº¦çš„ä»£å¸ä½™é¢',
                                '2. å¦‚æœä½™é¢ä¸è¶³ï¼Œä»ä»£å¸åˆçº¦å‘å·¥å‚åˆçº¦è½¬å…¥ä»£å¸',
                                '3. ç¡®ä¿å·¥å‚åˆçº¦æœ‰è¶³å¤Ÿçš„ä»£å¸ç”¨äºé¢„å”®',
                                '4. é‡æ–°æ‰§è¡Œ finalizePresaleAndAddLiquidity'
                            ]
                        });
                        break;
                        
                    default:
                        solutions.push({
                            issue: issue.type,
                            solution: 'éœ€è¦è¿›ä¸€æ­¥è¯Šæ–­',
                            action: 'further_diagnosis'
                        });
                }
            });
            
            return solutions;
        }
        
        // è·å–é¢„å”®çŠ¶æ€æ–‡æœ¬
        function getPresaleStatusText(status) {
            const statusMap = {
                0: 'æœªå¼€å§‹',
                1: 'è¿›è¡Œä¸­',
                2: 'å·²ç»“æŸ',
                3: 'äº¤æ˜“ä¸­',
                4: 'è§£é”ä¸­',
                5: 'å·²å®Œæˆ'
            };
            return statusMap[status] || `æœªçŸ¥çŠ¶æ€(${status})`;
        }
        
        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="result-section">
                    <h3>ğŸ“Š è¯Šæ–­ç»“æœæ€»è§ˆ</h3>
                    <p><strong>é¢„å”®åˆçº¦åœ°å€:</strong> <span id="address">${results.presaleAddress}</span> <button class="copy-button" onclick="copyToClipboard('${results.presaleAddress}')">å¤åˆ¶</button></p>
                    <p><strong>è¯Šæ–­æ—¶é—´:</strong> ${new Date(results.timestamp).toLocaleString()}</p>
                </div>
            `;
            
            // é¢„å”®çŠ¶æ€
            if (results.presaleStatus) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ“‹ é¢„å”®çŠ¶æ€</h3>
                        <p><strong>å½“å‰çŠ¶æ€:</strong> ${results.presaleStatus.presaleStatusText} (${results.presaleStatus.presaleStatus})</p>
                        <p><strong>æ˜¯å¦å·²å®Œæˆ:</strong> ${results.presaleStatus.isFinalized ? 'æ˜¯' : 'å¦'}</p>
                        <p><strong>è‡ªåŠ¨å®Œæˆ:</strong> ${results.presaleStatus.autoEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</p>
                        <p><strong>æµåŠ¨æ€§å·²æ·»åŠ :</strong> ${results.presaleStatus.liquidityAdded ? 'æ˜¯' : 'å¦'}</p>
                    </div>
                `;
            }
            
            // ä»£å¸çŠ¶æ€
            if (results.tokenStatus) {
                html += `
                    <div class="result-section">
                        <h3>ğŸª™ ä»£å¸çŠ¶æ€</h3>
                        ${results.tokenStatus.error ? 
                            `<p class="error">âŒ ${results.tokenStatus.error}</p>` :
                            `<p><strong>ä»£å¸åœ°å€:</strong> <span id="tokenAddress">${results.tokenStatus.tokenAddress}</span> <button class="copy-button" onclick="copyToClipboard('${results.tokenStatus.tokenAddress}')">å¤åˆ¶</button></p>
                             <p><strong>ä»£å¸åç§°:</strong> ${results.tokenStatus.tokenName}</p>
                             <p><strong>ä»£å¸ç¬¦å·:</strong> ${results.tokenStatus.tokenSymbol}</p>
                             <p><strong>ä»£å¸ç²¾åº¦:</strong> ${results.tokenStatus.tokenDecimals}</p>
                             <p><strong>æ€»ä¾›åº”é‡:</strong> ${results.tokenStatus.totalSupply}</p>`
                        }
                    </div>
                `;
            }
            
            // å·¥å‚çŠ¶æ€
            if (results.factoryStatus) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ­ å·¥å‚æˆæƒçŠ¶æ€</h3>
                        ${results.factoryStatus.error ? 
                            `<p class="error">âŒ ${results.factoryStatus.error}</p>` :
                            `<p><strong>å·¥å‚åœ°å€:</strong> <span id="factoryAddress">${results.factoryStatus.factoryAddress}</span> <button class="copy-button" onclick="copyToClipboard('${results.factoryStatus.factoryAddress}')">å¤åˆ¶</button></p>
                             <p><strong>æˆæƒé¢åº¦:</strong> ${results.factoryStatus.allowanceFormatted} (${results.factoryStatus.allowance})</p>`
                        }
                    </div>
                `;
            }
            
            // ä½™é¢çŠ¶æ€
            if (results.balanceStatus) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ’° åˆçº¦ä½™é¢</h3>
                        ${results.balanceStatus.error ? 
                            `<p class="error">âŒ ${results.balanceStatus.error}</p>` :
                            `<p><strong>ä»£å¸ä½™é¢:</strong> ${results.balanceStatus.tokenBalanceFormatted} (${results.balanceStatus.tokenBalance})</p>
                             <p><strong>BNBä½™é¢:</strong> ${results.balanceStatus.bnbBalanceFormatted} (${results.balanceStatus.bnbBalance})</p>
                             <p><strong>ç´¯ç§¯BNB:</strong> ${results.balanceStatus.accumulatedBNBFormatted} (${results.balanceStatus.accumulatedBNB})</p>`
                        }
                    </div>
                `;
            }
            
            // é—®é¢˜åˆ†æ
            if (results.issues && results.issues.length > 0) {
                html += `
                    <div class="result-section">
                        <h3>ğŸš¨ å‘ç°çš„é—®é¢˜</h3>
                        ${results.issues.map(issue => `
                            <div class="issue-item ${issue.severity}">
                                <strong>${getIssueTypeText(issue.type)}</strong><br>
                                ${issue.message}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                html += `
                    <div class="result-section">
                        <h3>âœ… é—®é¢˜æ£€æŸ¥</h3>
                        <p class="success">æœªå‘ç°æ˜æ˜¾é—®é¢˜ï¼Œé¢„å”®çŠ¶æ€æ­£å¸¸ã€‚</p>
                    </div>
                `;
            }
            
            // è§£å†³æ–¹æ¡ˆ
            if (results.solutions && results.solutions.length > 0) {
                html += `
                    <div class="result-section">
                        <h3>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h3>
                        ${results.solutions.map(solution => `
                            <div class="solution-item">
                                <strong>é—®é¢˜ç±»å‹:</strong> ${getIssueTypeText(solution.issue)}<br>
                                <strong>è§£å†³æ–¹æ¡ˆ:</strong> ${solution.solution}<br>
                                ${solution.steps ? `
                                    <strong>å…·ä½“æ­¥éª¤:</strong>
                                    <ol class="solution-steps">
                                        ${solution.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // è·å–é—®é¢˜ç±»å‹æ–‡æœ¬
        function getIssueTypeText(type) {
            const typeMap = {
                'PRESALE_STATUS_ERROR': 'é¢„å”®çŠ¶æ€é”™è¯¯',
                'PRESALE_NOT_ENDED': 'é¢„å”®æœªç»“æŸ',
                'PRESALE_ALREADY_FINALIZED': 'é¢„å”®å·²å®Œæˆ',
                'TOKEN_STATUS_ERROR': 'ä»£å¸çŠ¶æ€é”™è¯¯',
                'TOKEN_ADDRESS_INVALID': 'ä»£å¸åœ°å€æ— æ•ˆ',
                'FACTORY_STATUS_ERROR': 'å·¥å‚çŠ¶æ€é”™è¯¯',
                'FACTORY_ADDRESS_INVALID': 'å·¥å‚åœ°å€æ— æ•ˆ',
                'NO_FACTORY_ALLOWANCE': 'æ— å·¥å‚æˆæƒ',
                'BALANCE_STATUS_ERROR': 'ä½™é¢çŠ¶æ€é”™è¯¯',
                'NO_ACCUMULATED_BNB': 'æ— ç´¯ç§¯BNB',
                'TRANSFER_FROM_FAILED_ROOT_CAUSE': 'TRANSFER_FROM_FAILED æ ¹æœ¬åŸå› '
            };
            return typeMap[type] || type;
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + text);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + text);
            });
        }
        
        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            document.getElementById('presaleAddress').value = '';
            diagnosticResults = null;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ é¢„å”®æµåŠ¨æ€§é—®é¢˜è¯Šæ–­å·¥å…·å·²åŠ è½½');
            console.log('ğŸ’¡ è¯·ç¡®ä¿å·²è¿æ¥ TronLink é’±åŒ…');
            
            // æ£€æŸ¥ TronWeb æ˜¯å¦å¯ç”¨
            if (typeof window.tronWeb !== 'undefined') {
                showStatus('âœ… TronWeb å·²è¿æ¥ï¼Œå¯ä»¥å¼€å§‹è¯Šæ–­', 'success');
            } else {
                showStatus('âš ï¸ è¯·å…ˆè¿æ¥ TronLink é’±åŒ…', 'warning');
            }
        });
    </script>
</body>
</html>
